generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// User模型 - 存储用户基本信息
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  name          String?
  password      String?   // 哈希后的密码，OAuth用户可为null
  image         String?
  emailVerified DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // 关联关系
  projects      Project[]
  
  @@index([email])
}

// Project模型 - 代表用户的一个剧本工程
model Project {
  id              String            @id @default(cuid())
  userId          String
  title           String
  description     String?
  content         String            @db.Text // 剧本内容（单文件模式，保留兼容）
  projectType     ProjectType       @default(SINGLE) // 项目类型：单文件/多文件
  status          String            @default("draft")
  workflowStatus  WorkflowStatus    @default(INITIALIZED)
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt

  // 关联关系
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  analyses        Analysis[]
  scriptVersions  ScriptVersion[]
  analysisJobs    AnalysisJob[]
  diagnosticReport DiagnosticReport?
  revisionDecisions RevisionDecision[]
  scriptFiles     ScriptFile[]      // 多文件模式（新增）

  @@index([userId])
  @@index([status])
  @@index([workflowStatus])
  @@index([projectType])        // 新增索引：按项目类型查询
  @@index([userId, projectType]) // 新增复合索引：用户的特定类型项目
}

// Analysis模型 - 存储对某一个项目的AI分析结果
model Analysis {
  id          String    @id @default(cuid())
  projectId   String
  status      String    @default("pending") // pending, processing, completed, failed
  result      Json?     // 分析结果JSON
  errors      Json?     // 错误信息JSON
  suggestions Json?     // 修改建议JSON
  startedAt   DateTime?
  completedAt DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // 关联关系
  project     Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([status])
}

// ScriptVersion模型 - 存储剧本版本历史
model ScriptVersion {
  id          String   @id @default(cuid())
  projectId   String
  version     Int
  content     String   @db.Text
  changeLog   String?  @db.Text // 版本变更说明
  synthesisMetadata Json? // Epic 007: Synthesis元数据(decisionsApplied, styleProfile, etc.)
  confidence  Float?   // Epic 007: 合成置信度 (0-1)
  createdAt   DateTime @default(now())

  // 关联关系
  project     Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, version])
  @@index([projectId])
  @@index([projectId, version])
}

// AnalysisJob模型 - 异步分析任务管理
model AnalysisJob {
  id        String      @id @default(cuid())
  projectId String
  type      JobType
  status    JobStatus   @default(QUEUED)
  result    Json?
  error     String?
  metadata  Json?       // 额外的任务元数据
  startedAt DateTime?
  completedAt DateTime?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  // 关联关系
  project   Project     @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([status])
  @@index([type])
}

// DiagnosticReport模型 - Act 1诊断报告（支持多文件分析）
model DiagnosticReport {
  id                    String   @id @default(cuid())
  projectId             String   @unique
  findings              Json     // 结构化的诊断结果 (DiagnosticFindings: {internalFindings, crossFileFindings, summary})
  summary               String?  @db.Text // 报告摘要
  confidence            Float?   // 诊断置信度 (0-1)
  analyzedFileIds       String[] // 已分析的文件ID列表（用于增量更新）
  checkType             String   @default("internal_only") // 检查类型: internal_only, cross_file, both
  internalErrorCount    Int      @default(0) // 单文件错误数（冗余字段，优化查询）
  crossFileErrorCount   Int      @default(0) // 跨文件错误数（冗余字段，优化查询）
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // 关联关系
  project               Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([checkType])
  @@index([internalErrorCount])
  @@index([crossFileErrorCount])
}

// RevisionDecision模型 - 存储用户在迭代过程中的决策
model RevisionDecision {
  id               String   @id @default(cuid())
  projectId        String
  act              ActType
  focusName        String   // 聚焦对象名称（例如角色名）
  focusContext     Json     // 聚焦上下文（例如矛盾描述）
  proposals        Json     // AI生成的提案
  userChoice       String?  // 用户选择的提案ID
  generatedChanges Json?    // 最终生成的修改
  version          Int      @default(1)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // 关联关系
  project          Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([act])
  @@index([projectId, act])
}

// 项目类型枚举
enum ProjectType {
  SINGLE          // 单文件分析项目（ACT1-5 + Synthesis）
  MULTI_FILE      // 多文件分析项目（跨文件一致性检查）
}

// 工作流状态枚举
enum WorkflowStatus {
  INITIALIZED     // 初始化
  ACT1_RUNNING    // Act 1 正在执行
  ACT1_COMPLETE   // Act 1 完成
  ITERATING       // 迭代阶段
  SYNTHESIZING    // 综合阶段
  COMPLETED       // 全部完成
}

// 任务类型枚举
enum JobType {
  ACT1_ANALYSIS   // Act 1 基础诊断
  SYNTHESIS       // Epic 007: 剧本合成
  ITERATION       // 迭代优化
  EXPORT          // Epic 007: 导出任务
}

// 任务状态枚举
enum JobStatus {
  QUEUED          // 队列中
  PROCESSING      // 处理中
  COMPLETED       // 完成
  FAILED          // 失败
  CANCELLED       // 已取消
}

// 幕类型枚举
enum ActType {
  ACT2_CHARACTER      // Act 2: 角色弧光压力测试
  ACT3_WORLDBUILDING  // Act 3: 世界构建
  ACT4_PACING         // Act 4: 节奏
  ACT5_THEME          // Act 5: 主题
}

// ScriptFile模型 - 存储项目的多个剧本文件（多文件分析系统）
model ScriptFile {
  id                String   @id @default(cuid())
  projectId         String
  filename          String   // 原始文件名（如"第1集.md"）
  episodeNumber     Int?     // 集数编号（用于排序，从文件名提取）
  rawContent        String   @db.Text // 原始文本内容
  jsonContent       Json?    // 转换后的结构化JSON
  contentHash       String   // SHA256哈希（用于检测重复，Beta版暂不启用前端提示）
  fileSize          Int      // 文件大小（bytes）
  conversionStatus  String   @default("pending") // pending, processing, completed, failed
  conversionError   String?  @db.Text // 转换错误信息
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // 关联关系
  project           Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, filename]) // 同一项目内文件名唯一
  @@index([projectId])
  @@index([projectId, episodeNumber])
}