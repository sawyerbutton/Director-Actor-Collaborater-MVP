# 待讨论事项清单

**文档版本**: v1.0
**创建日期**: 2025-01-03
**状态**: ⏳ 等待业务部门确认

---

## 📋 概述

本文档记录了在多剧本文件分析系统（Beta版）开发过程中，需要与业务部门进一步讨论和澄清的问题。这些问题不影响当前**8天Beta版计划**的执行，但对**后续迭代（V1.1及以后）**具有重要意义。

**当前状态**：
- ✅ **ACT1 Beta版（8天）**：已批准，正在执行
- ⏳ **Sprint 5智能修改功能**：待讨论
- ⏳ **P0问题定义**：待讨论
- ⏳ **与现有ACT2-5集成**：待讨论

---

## 🎯 议题一：Sprint 5智能修改功能

### 背景

业务部门提出在ACT1 Beta版之后，新增**Sprint 5（智能修改功能）**，用于解决：
1. 无限递归：修改A引入问题B，修改B引入问题C...
2. 全局污染：修改角色A影响了无关的情节B
3. 结构崩溃：修改核心设定导致主线逻辑失效

**业务方提议的技术方案（三支柱）**：
1. **稳定阈值**：循环>3次或问题未减少→强制停止
2. **粗颗粒依赖映射+局部回查**：按场景/角色映射，只检查受影响部分
3. **P0冲突检测**：AI预判+用户确认弹窗

### 待讨论问题

#### 1️⃣ 功能定位与范围

**问题**：Sprint 5的"智能修改"与现有系统的关系？

**现状**：
- 系统已有ACT2-5迭代工作流
- 已有`RevisionDecision`模型存储用户决策
- 已有`POST /api/v1/iteration/propose`和`execute` API

**选项**：
- [ ] **A. 替换现有ACT2-5**：Sprint 5是全新的修改系统，替代现有迭代工作流
- [ ] **B. 增强现有ACT2-5**：Sprint 5是现有ACT2-5的修改执行增强层
- [ ] **C. 独立模块**：Sprint 5是与ACT2-5并行的"快速修复"模块

**影响**：直接影响数据库设计、API架构、前端UI规划

**技术疑问**：
- 业务文档中的"王子未婚妻"案例，是ACT2（角色深度）还是ACT5（主题共鸣）的问题？
- 如果是增强现有系统，如何与CharacterArchitect等Agent协同？

---

#### 2️⃣ 工时评估

**业务方预估**：3天
**技术评估**：6-7天（保守估计）

| 模块 | 业务方预估 | 技术评估 | 差异原因 |
|------|-----------|---------|---------|
| 稳定阈值逻辑 | 0.5天 | 0.5天 | 一致 |
| 依赖映射（粗颗粒） | 0.5天 | 1天 | 需设计映射规则+提取逻辑 |
| 局部回查逻辑 | 0.5天 | 0.5天 | 一致 |
| **P0冲突检测Prompt** | 1天 | **2-3天** | 高度复杂，需多轮调优 |
| 修改执行API | 0.5天 | 1天 | 需精确定位+验证 |
| 前端P0警告弹窗 | 0.5天 | 0.5天 | 一致 |
| 测试与调优 | 0.5天 | 1天 | 业务逻辑复杂 |

**待确认**：
- [ ] 可接受的工时范围（3天 vs 6-7天）
- [ ] 是否分阶段实施（MVP版本+完整版本）

---

#### 3️⃣ 技术方案细节

**问题3.1：依赖映射的实现**

**疑问**：
- 依赖关系从哪里获取？
  - [ ] JSON结构化数据（需要Sprint 2 JSON转换完成）
  - [ ] AI实时提取（需要额外Prompt，增加成本）
  - [ ] 用户手动标记（不现实）
- 如何判断"场景A影响场景B"？
  - [ ] 共享角色？
  - [ ] 时间线前后关系？
  - [ ] 情节因果关系？（需要深度语义理解）

**问题3.2：局部回查的范围**

**技术挑战**：
- 如果修改引入新角色，是否需要扩展检查范围？
- 跨文件检查如何"局部化"？（跨文件本身就是全局的）
- 性能如何？（每次修改重新调用LLM API，等待30秒？）

**问题3.3：P0冲突检测的准确性**

**关键风险**：
- 如何让AI理解"主线崩溃"？（需要剧本因果图谱）
- 如何避免误报？（AI可能过于保守，所有修改都警告）
- 如何避免漏报？（关键冲突未检测到）

**待确认**：
- [ ] 误报率容忍度（宁可误报 / 宁可漏报 / 平衡）
- [ ] 用户点击"继续"后如何处理？（记录知情同意？）

---

#### 4️⃣ 推荐方案对比

**方案A：最小可行版（2天）** ⭐ 推荐

| 功能 | 实现 | 工时 |
|------|------|------|
| 稳定阈值 | ✅ 循环3次后强制停止 | 0.5天 |
| 基础修改 | ✅ 用户手动确认每次修改 | 1天 |
| 简单回查 | ✅ 修改后重新检测全剧本（不局部） | 0.5天 |
| **总计** | - | **2天** |

**优势**：快速验证，降低风险，用户仍可手动判断P0冲突

**劣势**：无智能P0检测，全局回查较慢

---

**方案B：完整版（6-7天）**

所有三支柱全实现，P0检测准确率需要长期调优。

**优势**：实现业务方完整愿景

**劣势**：开发时间翻倍，技术风险高

---

**方案C：混合渐进式（2+3天）** ⭐ 推荐

- **Phase 1（Sprint 5A，2天）**：最小版本，Beta后立即交付
- **Phase 2（Sprint 5B，+3天）**：基于Beta反馈调优P0检测

**优势**：平衡速度与愿景，分两阶段验证

---

### 需要业务部门确认

- [ ] **1. 功能定位**：选择A/B/C（替换/增强/独立）
- [ ] **2. 工时预算**：接受2天（方案A）/ 6-7天（方案B）/ 2+3天（方案C）
- [ ] **3. 依赖映射规则**：如何判断"场景影响关系"
- [ ] **4. P0检测容忍度**：误报率vs漏报率的平衡

---

## 🎯 议题二：P0问题定义与分级规则

### 背景

业务文档多次提到"P0级问题"、"结构性问题"，但当前系统使用`severity`字段（critical/high/medium/low）。

### 待讨论问题

#### 1️⃣ 优先级体系

**问题**：P0/P1/P2/P3如何映射到severity？

**建议映射方案**：

| 优先级 | Severity | 定义 | 示例 |
|--------|----------|------|------|
| P0 | critical | 结构性问题，修改会导致主线崩溃 | 删除核心设定、杀死主角、改变世界观规则 |
| P1 | high | 重要性问题，影响重要支线 | 角色关系变化、次要情节调整 |
| P2 | medium | 普通性问题，局部优化 | 对话润色、场景细节 |
| P3 | low | 细微性问题，格式修正 | 错别字、标点符号 |

**替代方案**：
- [ ] 新增`priority`字段（P0/P1/P2/P3），与`severity`并存
- [ ] 统一使用`severity`（critical作为P0）

---

#### 2️⃣ P0判断规则

**问题**：如何判断一个问题是P0？

**技术方案**：

**方案A：规则判断**
```typescript
const isP0 = (error: LogicError) => {
  // 规则1：影响主角生死
  if (error.affectedCharacters.includes(mainProtagonist)) return true;

  // 规则2：核心设定冲突
  if (error.type === 'worldbuilding' && error.isCoreSetting) return true;

  // 规则3：主线情节崩溃
  if (error.affectedPlotLines.includes(mainStoryLine)) return true;

  return false;
};
```

**方案B：AI判断**
```typescript
const isP0 = await ai.classify({
  prompt: "判断此问题是否会导致主线逻辑崩溃",
  error: errorDescription
});
```

**方案C：用户标记**
- 用户在诊断报告中手动标记P0问题

**待确认**：
- [ ] 选择方案A（规则）/ B（AI）/ C（用户）
- [ ] 如果选AI，谁来设计Prompt？
- [ ] 如果选规则，如何定义"核心设定"、"主线情节"？

---

#### 3️⃣ 数据库设计

**问题**：是否需要扩展DiagnosticReport结构？

**选项1：新增priority字段**
```prisma
model DiagnosticReport {
  // ... 现有字段
  findings Json // 扩展结构：
  // {
  //   ...
  //   "priority": "P0" | "P1" | "P2" | "P3",
  //   "isStructural": boolean
  // }
}
```

**选项2：保持现有severity**
```typescript
// P0 = severity === 'critical'
// P1 = severity === 'high'
// ...
```

**待确认**：
- [ ] 选择选项1（新增字段）/ 选项2（复用severity）

---

### 需要业务部门确认

- [ ] **1. 优先级定义**：确认P0/P1/P2/P3的完整定义
- [ ] **2. P0判断方式**：规则/AI/用户标记
- [ ] **3. 数据库设计**：新增priority字段 or 复用severity

---

## 🎯 议题三：与现有ACT2-5的集成方式

### 背景

当前系统已经实现了完整的ACT2-5迭代工作流：

**现有功能**：
- ACT2（CharacterArchitect）：角色深度创作
- ACT3（RulesAuditor）：世界观丰富化
- ACT4（PacingStrategist）：节奏优化
- ACT5（ThematicPolisher）：主题共鸣

**现有API**：
- `POST /api/v1/iteration/propose`：生成AI提案
- `POST /api/v1/iteration/execute`：执行选中提案
- `GET /api/v1/projects/:id/decisions`：决策历史

### 待讨论问题

#### 1️⃣ 功能重叠分析

**疑问**：Sprint 5的"智能修改"与ACT2-5的关系？

**场景对比**：

| 场景 | ACT2-5现有能力 | Sprint 5新能力 | 是否重叠？ |
|------|---------------|---------------|-----------|
| 修复角色矛盾 | ✅ ACT2 CharacterArchitect | ✅ 智能修改 | ⚠️ 重叠 |
| 深化角色弧光 | ✅ ACT2 P4-P6 Prompt链 | ❌ | 无重叠 |
| 修复世界观冲突 | ✅ ACT3 RulesAuditor | ✅ 智能修改 | ⚠️ 重叠 |
| 检测P0冲突 | ❌ | ✅ P0冲突检测 | 无重叠 |
| 防无限递归 | ❌ | ✅ 稳定阈值 | 无重叠 |

**业务案例："王子未婚妻"**

这个案例涉及：
- 角色设定修改（删除"死去的未婚妻"）
- 感情线影响（王子拒绝表白的动机）
- 事业线崩溃（哥哥复仇动机消失）

**疑问**：
- 这是ACT2（角色深度）的问题吗？
- 还是ACT5（主题共鸣）的问题？
- 还是跨ACT的"结构性问题"？

---

#### 2️⃣ 集成方案

**方案A：增强ACT2-5执行层**

将Sprint 5的能力集成到现有`execute` API：

```typescript
// 现有API
POST /api/v1/iteration/execute
{
  decisionId: "...",
  proposalChoice: 0
}

// 增强后
POST /api/v1/iteration/execute
{
  decisionId: "...",
  proposalChoice: 0,
  enableP0Detection: true,  // 新增：P0冲突检测
  enableStabilityCheck: true // 新增：稳定阈值检查
}

// 返回
{
  success: true,
  p0Conflicts: [...]  // 如果检测到P0冲突
  stabilityStatus: { loops: 2, stable: true }
}
```

**优势**：
- ✅ 统一架构，不引入新模块
- ✅ ACT2-5的修改自动享有P0检测和稳定阈值保护
- ✅ 用户体验一致

**劣势**：
- ⚠️ 需要重构现有execute逻辑
- ⚠️ P0检测Prompt需要适配每个ACT

---

**方案B：独立"快速修复"模块**

Sprint 5是与ACT2-5并行的独立模块：

```
/api/v1/iteration/...  （现有ACT2-5）
/api/v1/quick-fix/...  （新增Sprint 5）

用户选择：
- 路径A：ACT2-5迭代工作流（深度创作）
- 路径B：快速修复（只修复错误，不做创作）
```

**优势**：
- ✅ 不影响现有ACT2-5
- ✅ 快速修复和深度创作分离，定位清晰

**劣势**：
- ⚠️ 两套API，用户可能困惑
- ⚠️ 功能重叠（如修复角色矛盾）

---

**方案C：分层架构**

```
┌─────────────────────────────────┐
│   用户选择修改操作（ACT2-5）      │
└────────────┬────────────────────┘
             │
             ▼
┌─────────────────────────────────┐
│   智能修改引擎（Sprint 5核心）    │
│   - P0冲突检测                   │
│   - 稳定阈值                     │
│   - 局部回查                     │
└─────────────────────────────────┘
             │
             ▼
       修改执行成功
```

**优势**：
- ✅ Sprint 5作为底层引擎，服务所有修改操作
- ✅ ACT2-5自动享有智能修改能力

**劣势**：
- ⚠️ 架构复杂度提升
- ⚠️ 需要精心设计接口

---

### 需要业务部门确认

- [ ] **1. "王子未婚妻"案例定位**：属于哪个ACT？还是跨ACT问题？
- [ ] **2. 集成方案选择**：方案A（增强）/ B（独立）/ C（分层）
- [ ] **3. 用户体验定位**：
  - Sprint 5是"快速修复"工具？
  - 还是ACT2-5的"智能保护层"？

---

## 📊 讨论优先级

| 议题 | 优先级 | 影响范围 | 建议讨论时间 |
|------|--------|---------|-------------|
| **议题一：Sprint 5功能范围** | 🔴 高 | 影响V1.1规划、后续开发排期 | Sprint 1-2期间（Day 1-4） |
| **议题二：P0问题定义** | 🟡 中 | 影响Sprint 5设计、数据库Schema | Sprint 2-3期间（Day 3-6） |
| **议题三：ACT2-5集成方式** | 🟢 低 | 影响Sprint 5架构设计 | Sprint 3期间（Day 5-8） |

**建议时间表**：
- **Week 1（Day 1-4）**：讨论议题一（Sprint 5范围和工时）
- **Week 2（Day 5-8）**：讨论议题二和三（P0定义和集成方案）

---

## ✅ 行动项

### 业务部门需要提供

1. **Sprint 5定位确认**
   - [ ] 选择功能定位（替换/增强/独立）
   - [ ] 确认工时预算（2天/6-7天/2+3天）
   - [ ] 明确"王子未婚妻"案例归属

2. **P0问题定义**
   - [ ] 提供完整的P0/P1/P2/P3定义
   - [ ] 选择P0判断方式（规则/AI/用户）
   - [ ] 确认数据库设计方案

3. **集成方案**
   - [ ] 选择集成方式（增强/独立/分层）
   - [ ] 明确用户体验定位

### 技术团队待办

1. **继续执行ACT1 Beta版（8天）**
   - ✅ 不受待讨论事项影响
   - ✅ 按计划交付多文件分析系统

2. **准备Sprint 5技术方案**
   - ⏳ 基于业务部门反馈
   - ⏳ 在Sprint 2-3期间完成设计

---

## 📝 更新日志

| 日期 | 版本 | 更新内容 |
|------|------|---------|
| 2025-01-03 | v1.0 | 初始版本，记录3个待讨论议题 |

---

**文档状态**: ⏳ 等待业务部门反馈
**下一步**: 业务部门审阅并提供反馈
**联系方式**: [待补充]
