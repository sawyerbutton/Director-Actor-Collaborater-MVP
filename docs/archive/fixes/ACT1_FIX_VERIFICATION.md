# ACT1 原文显示修复 - 快速验证指南

## ✅ 修复已完成

**服务器状态**: ✅ 运行中 (http://localhost:3000)
**修复内容**: ACT1分析结果现在会显示完整的原文和建议修改内容

---

## 🧪 快速验证步骤（5分钟）

### 步骤1: 创建测试剧本

创建文件 `test-act1-fix.txt`，内容如下：

```
场景1：咖啡馆 - 日 - 内景

小明坐在窗边的位置，焦虑地看着手机。

小明：（自言自语）她怎么还没到？已经晚了二十分钟了。

小红突然推门进来，看起来很匆忙。

小红：对不起对不起！地铁堵了。

小明：（松了一口气）没事，我还以为你不来了呢。

场景2：咖啡馆 - 日 - 内景（半小时后）

两人聊得很开心。

小红：你知道吗？我其实一直想告诉你一件事...

小明：什么事？

小红：我... 我要出国了。下个月就走。

小明：（震惊）什么？你从来没提过啊！

场景3：街道 - 夜 - 外景

小明一个人走在街上，表情复杂。他看着手机里的照片。

旁白：有些事情，等你想说的时候，已经太晚了。

场景4：机场 - 日 - 外景

小明拿着一束花站在出发大厅。

小明：（对自己说）还是来送她吧...

小红看到小明，惊讶地走过来。

小红：你怎么来了？

小明：我想... 我想告诉你一件事。

小红：什么事？我的飞机马上就要起飞了。

小明：我... 算了，没什么。祝你一路顺风。

小红：谢谢你来送我。（拥抱小明后转身离开）

场景5：小明的房间 - 夜 - 内景

小明躺在床上，看着天花板。手机突然响了，是小红发来的消息。

手机屏幕显示："我也喜欢你。我们试试异地恋吧。"

小明露出笑容。
```

**这个剧本故意包含了多种逻辑问题**:
- ❌ 时间线跳跃（场景2说"半小时后"，但没有清晰的时间线）
- ❌ 场景3到场景4时间不连贯（从夜晚直接到白天）
- ❌ 角色动机不明确（小明为什么不直接表白）
- ❌ 对话不连贯（小红说"下个月就走"但场景4立即就在机场）

---

### 步骤2: 上传并分析

1. 访问 http://localhost:3000/dashboard
2. 上传 `test-act1-fix.txt`
3. 点击"开始AI分析"
4. 等待30-90秒

---

### 步骤3: 检查修复效果

分析完成后，检查以下内容：

#### ✅ 检查点1: 原文字段不再为空

**修复前**:
```
原文：[空]
```

**修复后（期望）**:
```
原文：
小明：（自言自语）她怎么还没到？已经晚了二十分钟了。
```

#### ✅ 检查点2: 建议修改字段不再为空

**修复前**:
```
建议修改为：[空]
```

**修复后（期望）**:
```
建议修改为：
小明：（看着手表）她怎么还没到？已经晚了二十分钟了。
```

#### ✅ 检查点3: 行号和场景信息正确

**期望显示**:
```
中
plot
行 42
置信度: 85%

原文：
小明：我想... 我想告诉你一件事。
小红：什么事？我的飞机马上就要起飞了。
小明：我... 算了，没什么。

建议修改为：
小明：我想... 我想告诉你，我喜欢你。
小红：什么？（停下脚步）
小明：我知道你要出国了，但我必须告诉你我的感受。
```

#### ✅ 检查点4: 错误类型正确分类

应该看到多种类型的错误：
- ⏰ **timeline** (时间线): 时间跳跃、顺序混乱
- 👤 **character** (角色): 动机不明、性格不一致
- 📖 **plot** (剧情): 情节漏洞、因果关系不清
- 💬 **dialogue** (对话): 对话不自然、信息不连贯
- 🎬 **scene** (场景): 场景转换突兀

---

## 🔍 详细验证检查表

打印此清单，逐项验证：

### 基础功能
- [ ] 分析完成后显示错误总数（应该>0）
- [ ] 每个严重度级别都有统计（高/中/低）
- [ ] 错误卡片可以展开查看详情

### 原文显示
- [ ] **【关键】** 所有错误的"原文"字段都有内容（非空）
- [ ] 原文内容是实际的剧本片段（可识别）
- [ ] 原文长度合理（不过短或过长）
- [ ] 原文使用等宽字体显示（font-mono）
- [ ] 原文在红色背景框内（bg-red-50）

### 建议修改显示
- [ ] **【关键】** 所有错误的"建议修改为"字段都有内容（非空）
- [ ] 建议内容是中文描述
- [ ] 建议具体可操作
- [ ] 建议使用等宽字体显示
- [ ] 建议在绿色背景框内（bg-green-50）

### 元数据显示
- [ ] 错误类型标签显示（timeline/character/plot/dialogue/scene）
- [ ] 严重度标签显示并有颜色区分
- [ ] 行号显示（不是"行 0"）
- [ ] 置信度显示（在60-100范围内）

### 错误描述
- [ ] 描述使用中文
- [ ] 描述清晰解释了问题所在
- [ ] 描述与原文相关

---

## 🐛 如果仍然有问题

### 问题1: 原文仍然为空

**可能原因**:
1. DeepSeek API没有按照新prompt返回数据
2. 缓存了旧的分析结果

**解决方案**:
```bash
# 1. 清空数据库中的旧分析结果
# 2. 重新上传剧本
# 3. 查看服务器日志确认AI响应
```

**检查AI响应**:
打开浏览器开发者工具（F12） → Network → 找到 `/api/v1/projects/:id/report` 请求 → 查看响应JSON中的`findings[0].location.content`字段

### 问题2: 部分原文为空，部分有内容

**可能原因**:
AI在某些情况下没有提取到原文

**解决方案**:
这是正常的边缘情况。可以在`ConsistencyGuardian.ts`中添加fallback逻辑：

```typescript
// 如果location.content为空，使用context作为备用
if (error.location && !error.location.content && error.context) {
  error.location.content = error.context.substring(0, 200);
}
```

### 问题3: 原文内容不准确

**可能原因**:
AI提取的文本片段不够精确

**解决方案**:
这需要进一步优化prompt，或者在后端添加文本提取逻辑，直接从剧本中定位并提取原文。

---

## 📊 预期AI响应示例

成功的API响应应该类似：

```json
{
  "success": true,
  "data": {
    "report": {
      "findings": [
        {
          "id": "uuid-xxx",
          "type": "timeline",
          "severity": "high",
          "location": {
            "sceneNumber": 2,
            "line": 15,
            "content": "场景2：咖啡馆 - 日 - 内景（半小时后）",
            "timeReference": "半小时后"
          },
          "description": "场景2标注为'半小时后'，但没有明确的起点时间，且场景1未提供具体时间",
          "suggestion": "在场景1添加时间标记（如'上午10点'），或在场景2使用绝对时间（如'上午10点30分'）",
          "context": "场景1到场景2的时间跳跃...",
          "confidence": 88
        },
        {
          "id": "uuid-yyy",
          "type": "plot",
          "severity": "medium",
          "location": {
            "sceneNumber": 4,
            "line": 42,
            "content": "小明：我想... 我想告诉你一件事。\n小红：什么事？我的飞机马上就要起飞了。\n小明：我... 算了，没什么。",
            "characterName": "小明"
          },
          "description": "小明在关键时刻选择不表白，缺少足够的心理动机解释",
          "suggestion": "增加小明的内心独白或回忆片段，解释他为什么在最后一刻退缩",
          "confidence": 82
        }
      ],
      "summary": {
        "totalErrors": 8,
        "byType": {
          "timeline": 2,
          "character": 2,
          "plot": 3,
          "dialogue": 1
        }
      }
    }
  }
}
```

---

## ✨ 修复成功的标志

如果你看到以下情况，说明修复成功：

1. ✅ 每个错误都有完整的"原文"显示
2. ✅ 每个错误都有具体的"建议修改为"内容
3. ✅ 行号不再是"0"
4. ✅ 场景编号正确
5. ✅ 错误描述和原文匹配
6. ✅ 所有文本都是中文

---

## 📞 获取帮助

如果验证中遇到问题：

1. **查看详细修复报告**: `ACT1_ORIGINAL_TEXT_FIX.md`
2. **查看服务器日志**: 检查Background Bash进程输出
3. **检查API响应**: 浏览器开发者工具 → Network标签
4. **查看数据库**: `npx prisma studio` → DiagnosticReport表

---

**修复时间**: 2025-10-02
**服务器**: http://localhost:3000
**状态**: ✅ 运行中，等待验证
