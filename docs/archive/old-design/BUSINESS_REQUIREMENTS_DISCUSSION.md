# 业务需求讨论 - ACT1工时优化 & 智能修改功能

**文档版本**: v1.0
**创建日期**: 2025-01-03
**讨论主题**:
1. ACT1 Beta版工时削减方案（10天 → 8天）
2. 新增智能修改功能（Sprint 5，+3天）

---

## 📋 议题一：ACT1工时削减方案

### 业务方提议

削减3个P2优先级功能，节省2天：

| 任务ID | 功能 | 节省时间 | 业务理由 |
|--------|------|---------|---------|
| T1.5 | 文件内容去重（Hash检测） | 0.5天 | Beta版信任用户，防呆功能可后置 |
| T2.10 | 转换进度条 | 0.5天 | 用简单"处理中..."替代复杂进度条 |
| T3.13 | 跨文件问题关联高亮 | 1天 | 先用纯文本列表，高亮可后置 |
| **总计** | - | **2天** | **保留核心功能，牺牲体验换速度** |

### 技术评估

#### ✅ 支持削减 - 总体评估：**合理**

**理由**：
1. **核心价值链完整保留**
   - ✅ FR-04: 剧本→JSON转换（Sprint 2核心）
   - ✅ FR-05: 单文件逻辑检查（复用ConsistencyGuardian）
   - ✅ FR-06: 跨文件一致性检查（CrossFileAnalyzer）
   - ✅ FR-07: 统一诊断报告（关键交付物）

2. **削减的都是UI增强功能**
   - 文件去重：技术上仍然会生成contentHash（数据库字段保留），只是不做前端提示
   - 进度条：用`useState`简单loading替代实时进度（节省WebSocket/轮询开发）
   - 关联高亮：跨文件问题用`affectedFiles`数组清晰列出即可

3. **降级方案可行**
   - T1.5: Hash字段保留，后期1小时可补回检测逻辑
   - T2.10: 简化为"转换中...N个文件"文本提示
   - T3.13: 用颜色编码区分单文件/跨文件问题（替代高亮）

#### ⚠️ 需要注意的风险

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 用户重复上传同一文件 | 数据库冗余 | 后端仍然生成Hash，V1.1可快速补回检测 |
| 转换时间长无反馈 | 用户焦虑 | 保留基础loading，显示文件名 |
| 跨文件问题理解困难 | 用户不知如何修复 | 在`description`字段中详细描述关联关系 |

### 调整后的时间表

| Sprint | 原计划 | 调整后 | 变化 | 关键交付 |
|--------|--------|--------|------|---------|
| Sprint 1 | 3天 | 2.5天 | -0.5天 (T1.5) | ScriptFile模型、上传API、前端UI |
| Sprint 2 | 2天 | 1.5天 | -0.5天 (T2.10) | Python微服务、JSON转换 |
| Sprint 3 | 4天 | 3天 | -1天 (T3.13) | 跨文件检查、诊断报告 |
| Sprint 4 | 1天 | 1天 | 无变化 | 测试、部署 |
| **总计** | **10天** | **8天** | **-2天** | **完整多文件分析系统** |

### ✅ 技术建议：**同意削减，按8天计划执行**

**前提条件**：
1. 数据库Schema保留`contentHash`字段（为后期扩展预留）
2. 诊断报告的`description`字段必须清晰描述跨文件关联（弥补无高亮的不足）
3. Beta测试时明确告知用户"部分UI功能精简版"

---

## 📋 议题二：智能修改功能（Sprint 5）

### 业务方提议

**新增Sprint 5（+3天）**，实现ACT2智能修改功能，解决：
- ❌ 无限递归：修改A引入问题B，修改B引入问题C...
- ❌ 全局污染：修改角色A影响了无关的情节B
- ❌ 结构崩溃：修改核心设定导致主线逻辑失效（如"王子未婚妻"案例）

**技术方案（三支柱）**：
1. **稳定阈值**：循环>3次或问题未减少→强制停止
2. **粗颗粒依赖映射+局部回查**：按场景/角色映射，只检查受影响部分
3. **P0冲突检测**：AI预判+用户确认弹窗

### 技术可行性分析

#### 🤔 关键问题清单

**问题1：与现有系统的关系**

当前系统已有ACT2-5迭代工作流：
- `RevisionDecision`模型（存储用户决策）
- `POST /api/v1/iteration/propose`（生成AI提案）
- `POST /api/v1/iteration/execute`（执行选中提案）

**疑问**：
- ❓ Sprint 5的"智能修改"是替换现有ACT2，还是增强ACT2？
- ❓ 如果是增强，如何与现有的CharacterArchitect等Agent协同？
- ❓ "王子未婚妻"案例是ACT2（角色深度）还是ACT5（主题共鸣）的问题？

**建议**：需要明确定位，避免功能重叠或冲突。

---

**问题2：P0问题的定义**

文档提到"P0级问题（如删核心设定）"，但当前系统的优先级是`severity`:
- `critical` / `high` / `medium` / `low`（4级）

**疑问**：
- ❓ P0/P1/P2/P3与severity的映射关系？
- ❓ 如何判断一个问题是"P0结构性问题"？
  - 例：角色矛盾 vs 核心设定冲突，如何区分？
- ❓ 谁来标记P0？AI还是用户？

**建议**：需要设计明确的分类规则，可能需要额外的`priority`字段。

---

**问题3：依赖映射的实现**

文档提到"粗颗粒依赖映射（按场景/角色）"。

**技术挑战**：
```typescript
// 假设的依赖结构
{
  "场景5": {
    "characters": ["张三", "李四"],
    "settings": ["城堡"],
    "relatedScenes": [1, 3, 10] // 如何确定？
  }
}
```

**疑问**：
- ❓ 依赖关系从哪里来？
  - JSON结构化数据（需要Sprint 2完成）
  - AI提取（需要额外的Prompt）
  - 用户手动标记（不现实）
- ❓ 如何判断"场景5的修改影响场景10"？
  - 共享角色？
  - 时间线前后关系？
  - 情节因果关系？（这需要深度语义理解）

**建议**：粗颗粒映射可行，但需要明确映射规则（建议从简单规则开始，如"共享角色的场景"）。

---

**问题4：局部回查的范围**

文档提到"只检测受影响部分"。

**技术实现**：
```typescript
// 修改场景5（包含张三）
const affectedScenes = scriptFiles
  .filter(file => file.jsonContent.scenes.some(s =>
    s.characters.includes("张三")
  ));

// 只对这些场景重新运行ConsistencyGuardian
const newErrors = await analyzeScriptText(affectedScenes.join('\n'));
```

**疑问**：
- ❓ 如果修改引入了新角色"王五"，是否需要扩展检查范围？
- ❓ 跨文件检查如何"局部化"？（跨文件本身就是全局的）
- ❓ 性能如何？（重新调用LLM API，每次修改都要等30秒？）

**建议**：局部回查可行，但需要明确"受影响"的定义，以及处理边界情况。

---

**问题5：P0冲突检测的Prompt设计**

文档提到"即时碰撞测试"。

**示例场景**（王子未婚妻）：
```
用户要修改：删除"王子有死去的未婚妻"这个设定

AI需要判断：
1. 这个设定被哪些情节引用？
   - 王子拒绝公主表白（感情线）
   - 未婚妻的哥哥要复仇（事业线）
2. 删除后会导致什么？
   - 感情线：王子为何拒绝？（动机消失）
   - 事业线：复仇动机消失 → boss收买失败 → 主线崩溃
3. 输出P0警告
```

**技术挑战**：
- ❓ 如何让AI理解"主线崩溃"？（需要剧本的因果图谱）
- ❓ 如何避免误报？（AI可能过于保守，所有修改都警告）
- ❓ 如何处理用户点击"继续"后的后果？（记录用户知情同意？）

**建议**：这是最复杂的部分，需要精心设计Prompt，可能需要多轮迭代调优。

---

#### ⏱️ 工时评估修正

业务方预估**3天**，技术评估如下：

| 模块 | 业务方预估 | 技术评估 | 理由 |
|------|-----------|---------|------|
| 稳定阈值逻辑 | 0.5天 | 0.5天 | ✅ 简单计数器，可行 |
| 依赖映射（粗颗粒） | 0.5天 | 1天 | ⚠️ 需要设计映射规则+提取逻辑 |
| 局部回查逻辑 | 0.5天 | 0.5天 | ✅ 复用ConsistencyGuardian |
| P0冲突检测Prompt | 1天 | **2-3天** | ❌ 高度复杂，需要多轮调优 |
| 修改执行API | 0.5天 | 1天 | ⚠️ 需要精确定位+验证 |
| 前端P0警告弹窗 | 0.5天 | 0.5天 | ✅ 简单UI |
| 测试与调优 | 0.5天 | 1天 | ⚠️ 业务逻辑复杂 |
| **总计** | **3天** | **6-7天** | **保守估计** |

**关键风险**：
- P0冲突检测的准确率可能不足（需要大量测试）
- 依赖映射可能遗漏边界情况
- 用户体验可能不流畅（频繁弹窗？）

---

### 🎯 技术建议：分阶段实施

#### 方案A：最小可行版（MVP of MVP）- 推荐

**范围**：只实现稳定阈值+基础修改

| 功能 | 实现 | 工时 |
|------|------|------|
| 稳定阈值 | ✅ 循环3次后强制停止 | 0.5天 |
| 基础修改 | ✅ 用户手动确认每次修改 | 1天 |
| 简单回查 | ✅ 修改后重新检测全剧本（不局部） | 0.5天 |
| **总计** | - | **2天** |

**优势**：
- ✅ 快速验证核心流程
- ✅ 降低技术风险
- ✅ 用户仍然可以手动判断P0冲突

**劣势**：
- ❌ 无智能P0检测（用户需要自己判断）
- ❌ 全局回查较慢（但Beta版可接受）

---

#### 方案B：完整版（按业务方要求）- 需要更多时间

**范围**：三支柱全实现

| 功能 | 实现 | 工时 |
|------|------|------|
| 稳定阈值 | ✅ | 0.5天 |
| 依赖映射+局部回查 | ✅ | 1.5天 |
| P0冲突检测 | ✅ | 2-3天 |
| 修改执行+前端 | ✅ | 1.5天 |
| 测试与调优 | ✅ | 1天 |
| **总计** | - | **6.5-7.5天** |

**优势**：
- ✅ 实现业务方完整愿景
- ✅ 用户体验更智能

**劣势**：
- ❌ 开发时间翻倍（3天→7天）
- ❌ P0检测准确率需要长期调优
- ❌ 技术风险较高

---

#### 方案C：混合渐进式（折中方案）- 推荐

**Phase 1（Sprint 5A，2天）**：
- ✅ 稳定阈值
- ✅ 基础修改+手动确认
- ✅ 全局回查（简化版）

**Phase 2（Sprint 5B，+3天，Beta后迭代）**：
- ✅ 依赖映射
- ✅ 局部回查
- ✅ P0冲突检测（基于Beta反馈调优）

**优势**：
- ✅ 快速交付可用版本（2天）
- ✅ 降低初期风险
- ✅ 保留完整愿景（分两阶段）

---

### 📊 关键决策点

需要业务方明确的问题：

| # | 问题 | 选项 | 影响 |
|---|------|------|------|
| 1 | 与现有ACT2-5的关系？ | A. 替换 / B. 增强 / C. 独立模块 | 架构设计 |
| 2 | P0问题的定义？ | A. AI自动判断 / B. 用户标记 / C. 规则判断 | Prompt设计 |
| 3 | 可接受的工时？ | A. 2天（最小版） / B. 7天（完整版） / C. 2+3天（分阶段） | 交付时间 |
| 4 | P0检测误报率容忍度？ | A. 宁可误报 / B. 宁可漏报 / C. 平衡 | Prompt调优方向 |
| 5 | 修改流程？ | A. 自动修改+回滚 / B. 每步确认 / C. 批量预览+确认 | 用户体验 |

---

## 🎯 综合建议

### 推荐方案：8天ACT1 + 2天Sprint 5A（最小智能修改）

**总时间**：10天
**交付物**：
1. **ACT1 Beta版**（8天）
   - 多文件上传、JSON转换、跨文件检查
   - 完整诊断报告（单文件+跨文件问题）
   - 简化版UI（无进度条、无高亮）

2. **智能修改MVP**（2天）
   - 稳定阈值（防无限递归）
   - 基础修改执行
   - 全局回查（简化版）
   - 用户手动判断P0冲突

**后续迭代**（Beta后，+3-5天）：
- 依赖映射+局部回查
- AI P0冲突检测
- UI增强（进度条、高亮）

---

## 📝 需要讨论的问题

### 立即需要确认（影响开发启动）

1. ✅ **ACT1削减方案**：是否批准8天计划？
2. ❓ **Sprint 5范围**：选择方案A（2天MVP）/ B（7天完整版）/ C（2+3天渐进式）？
3. ❓ **P0定义**：如何区分P0/P1/P2/P3问题？
4. ❓ **与现有ACT2关系**：是替换、增强还是独立？

### 可延后讨论（Sprint 1-3期间）

5. P0冲突检测的Prompt设计细节
6. 依赖映射的具体规则
7. 用户修改确认的交互流程

---

## 🚀 下一步行动

**如果业务方确认**：
1. ✅ ACT1削减方案（8天）
2. ✅ Sprint 5方案C（2天MVP + 3天后续）

**技术团队立即开始**：
1. 更新`MULTI_SCRIPT_ANALYSIS_REQUIREMENTS.md`（反映8天计划）
2. 开始Sprint 1开发（ScriptFile模型+上传API）
3. 并行设计Sprint 5A的最小修改流程

**预计总时间线**：
- Week 1 (Day 1-5): Sprint 1-2（多文件上传+JSON转换）
- Week 2 (Day 6-8): Sprint 3（跨文件检查+诊断报告）
- Week 2 (Day 9-10): Sprint 4（测试）+ Sprint 5A（修改MVP）

**Beta交付日期**：Day 10结束

---

**等待业务方反馈的关键问题**：
1. 是否同意8天ACT1计划？
2. Sprint 5选择哪个方案（A/B/C）？
3. P0问题如何定义？
4. 与现有ACT2-5的关系如何处理？

**文档状态**: ⏳ 待业务方确认
