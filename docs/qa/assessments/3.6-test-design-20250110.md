# Test Design: Story 3.6 - E2E Test Environment & Rate Limiting Integration

Date: 2025-01-10
Designer: Quinn (Test Architect)

## Test Strategy Overview

- **Total test scenarios**: 28
- **Unit tests**: 8 (29%)
- **Integration tests**: 12 (43%)
- **E2E tests**: 8 (28%)
- **Priority distribution**: P0: 15, P1: 8, P2: 5

## Test Scenarios by Acceptance Criteria

### AC1: Environment configuration correct, E2E tests run stably in WSL

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|--------------|
| 3.6-UNIT-001 | Unit | P0 | Validate DISPLAY env var detection | Pure environment check logic |
| 3.6-UNIT-002 | Unit | P0 | Test headless mode fallback logic | Algorithm for mode selection |
| 3.6-INT-001 | Integration | P0 | Playwright browser launch in WSL | Browser initialization component |
| 3.6-INT-002 | Integration | P0 | Test database connection pooling | DB connection management |
| 3.6-E2E-001 | E2E | P0 | Complete test suite execution in WSL | End-to-end environment validation |
| 3.6-E2E-002 | E2E | P1 | Parallel test execution stability | Concurrent test isolation |

**Risk Mitigation**: Addresses TECH-001 (WSL environment instability)

### AC2: Jest unit tests configuration fixed, tests execute normally

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|--------------|
| 3.6-UNIT-003 | Unit | P0 | NextAuth v5 mock validation | Mock interface compatibility |
| 3.6-UNIT-004 | Unit | P0 | Environment variable loading in tests | Config loading logic |
| 3.6-INT-003 | Integration | P0 | Jest with Next.js module resolution | Framework integration |
| 3.6-INT-004 | Integration | P1 | Test database transaction isolation | DB state management |
| 3.6-E2E-003 | E2E | P2 | Full Jest test suite execution | Complete unit test validation |

**Risk Mitigation**: Addresses TECH-002 (Jest/NextAuth incompatibility)

### AC3: NextAuth login endpoint integrates rate limiting (5 failures trigger)

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|--------------|
| 3.6-UNIT-005 | Unit | P0 | Rate limit counter increment logic | Pure counting algorithm |
| 3.6-UNIT-006 | Unit | P0 | TTL expiration calculation | Time-based reset logic |
| 3.6-INT-005 | Integration | P0 | Rate limiter with Redis storage | Distributed state management |
| 3.6-INT-006 | Integration | P0 | NextAuth signIn callback integration | Auth flow integration |
| 3.6-INT-007 | Integration | P0 | Rate limit response headers | HTTP response formatting |
| 3.6-INT-008 | Integration | P0 | IP and email-based key extraction | Request parsing logic |
| 3.6-E2E-004 | E2E | P0 | Sequential failed login rate limiting | User-facing rate limit behavior |
| 3.6-E2E-005 | E2E | P0 | Concurrent attack simulation | Security validation |

**Risk Mitigation**: Addresses SEC-001 (Rate limiter bypass), PERF-001 (Memory leak)

### AC4: E2E test pass rate reaches >80%

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|--------------|
| 3.6-INT-009 | Integration | P0 | Test retry mechanism validation | Retry logic component |
| 3.6-INT-010 | Integration | P1 | Test timeout configuration | Timing management |
| 3.6-INT-011 | Integration | P1 | Network failure recovery | Error handling |
| 3.6-E2E-006 | E2E | P0 | Full auth test suite execution | Complete auth flow validation |
| 3.6-E2E-007 | E2E | P1 | Test stability over multiple runs | Flakiness detection |

**Risk Mitigation**: Addresses OPS-001 (Test flakiness), BUS-001 (False positives)

### AC5: Test failure detailed logs and error reports generated

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|--------------|
| 3.6-UNIT-007 | Unit | P1 | Error message formatting | String formatting logic |
| 3.6-UNIT-008 | Unit | P2 | Screenshot capture trigger logic | Failure detection algorithm |
| 3.6-INT-012 | Integration | P1 | HTML report generation | Report builder component |
| 3.6-E2E-008 | E2E | P2 | Complete failure reporting flow | End-to-end reporting validation |

**Risk Mitigation**: Supports all risk detection and debugging

## Risk Coverage Matrix

| Risk ID | Test Scenarios | Coverage Level |
|---------|---------------|----------------|
| TECH-001 (WSL instability) | 3.6-UNIT-001/002, 3.6-INT-001/002, 3.6-E2E-001/002 | High |
| SEC-001 (Rate limit bypass) | 3.6-UNIT-005/006, 3.6-INT-005/006/007/008, 3.6-E2E-004/005 | Critical |
| TECH-002 (Jest incompatibility) | 3.6-UNIT-003/004, 3.6-INT-003/004 | High |
| OPS-001 (Test flakiness) | 3.6-INT-009/010/011, 3.6-E2E-007 | Medium |
| PERF-001 (Memory leak) | 3.6-UNIT-006, 3.6-INT-005 | Medium |
| DATA-001 (DB corruption) | 3.6-INT-002/004 | Medium |
| SEC-002 (Key extraction) | 3.6-INT-008 | Low |
| BUS-001 (False positives) | 3.6-E2E-007, 3.6-INT-012 | Low |

## Recommended Execution Order

### Phase 1: Critical Foundation (P0 Unit)
1. 3.6-UNIT-001: DISPLAY env var detection
2. 3.6-UNIT-002: Headless mode fallback
3. 3.6-UNIT-003: NextAuth mock validation
4. 3.6-UNIT-004: Environment variable loading
5. 3.6-UNIT-005: Rate limit counter logic
6. 3.6-UNIT-006: TTL expiration calculation

### Phase 2: Integration Validation (P0 Integration)
1. 3.6-INT-001: Playwright browser launch
2. 3.6-INT-002: Database connection pooling
3. 3.6-INT-003: Jest module resolution
4. 3.6-INT-005: Redis rate limiter integration
5. 3.6-INT-006: NextAuth callback integration
6. 3.6-INT-007: Rate limit headers
7. 3.6-INT-008: Key extraction logic
8. 3.6-INT-009: Retry mechanism

### Phase 3: End-to-End Validation (P0 E2E)
1. 3.6-E2E-001: WSL test suite execution
2. 3.6-E2E-004: Sequential rate limiting
3. 3.6-E2E-005: Concurrent attack simulation
4. 3.6-E2E-006: Full auth suite execution

### Phase 4: Stability Tests (P1)
1. 3.6-E2E-002: Parallel execution
2. 3.6-INT-004: Transaction isolation
3. 3.6-INT-010: Timeout configuration
4. 3.6-INT-011: Network recovery
5. 3.6-E2E-007: Multi-run stability
6. 3.6-UNIT-007: Error formatting
7. 3.6-INT-012: Report generation

### Phase 5: Nice-to-Have (P2)
1. 3.6-E2E-003: Jest suite validation
2. 3.6-UNIT-008: Screenshot triggers
3. 3.6-E2E-008: Reporting flow

## Test Data Requirements

### Environment Variables
```yaml
test_env:
  DISPLAY: ":0"
  DATABASE_URL: "postgresql://test@localhost/test_db"
  NEXTAUTH_SECRET: "test-secret-key"
  NEXTAUTH_URL: "http://localhost:3000"
  REDIS_URL: "redis://localhost:6379"
```

### Test User Data
```yaml
test_users:
  valid_user:
    email: "test@example.com"
    password: "Test123!@#"
  attack_user:
    email: "attacker@evil.com"
    password: "wrong-password"
  concurrent_users:
    - email: "user1@test.com"
    - email: "user2@test.com"
    - email: "user3@test.com"
```

### Rate Limit Test Data
```yaml
rate_limit_scenarios:
  sequential_failures: 6  # Trigger on 6th attempt
  concurrent_requests: 10 # Parallel attempts
  time_window: 900000     # 15 minutes in ms
  expected_status: 429    # Too Many Requests
```

## Test Environment Requirements

### WSL Configuration
- Ubuntu 20.04 or later
- X11 display server configured
- Sufficient memory (min 4GB)
- Network connectivity to host

### Docker Services
- PostgreSQL 15+
- Redis 7+
- Optional: Selenium Grid for parallel execution

### Browser Requirements
- Chromium (headless/headed)
- Firefox (optional)
- WebKit (optional)

## Success Metrics

### Coverage Goals
- **Unit Test Coverage**: >70% of business logic
- **Integration Coverage**: All critical paths
- **E2E Coverage**: All P0 user journeys

### Performance Targets
- **Unit Tests**: <5 seconds total
- **Integration Tests**: <30 seconds total
- **E2E Tests**: <2 minutes total
- **Full Suite**: <5 minutes

### Stability Targets
- **Pass Rate**: >80% consistent
- **Flaky Tests**: <5% of total
- **False Positives**: <1%

## Quality Gate Criteria

```yaml
test_design:
  scenarios_total: 28
  by_level:
    unit: 8
    integration: 12
    e2e: 8
  by_priority:
    p0: 15
    p1: 8
    p2: 5
  coverage_gaps: []  # All ACs covered
  risk_coverage:
    critical_risks: 100%  # Both critical risks covered
    high_risks: 100%      # Both high risks covered
    total_coverage: 100%  # All identified risks addressed
```

## Maintenance Considerations

### Test Stability
- Implement proper wait strategies (no hard sleeps)
- Use data-testid attributes for reliable selectors
- Clean database state between tests
- Mock external dependencies where appropriate

### Performance Optimization
- Run unit tests first (fail fast)
- Parallelize where possible
- Use test containers for isolation
- Cache dependencies between runs

### Documentation
- Document flaky test workarounds
- Maintain test data fixtures
- Update when requirements change
- Track known limitations

---

Test design complete. All acceptance criteria have comprehensive test coverage with appropriate test levels and priorities assigned. Critical risks are addressed with P0 tests to ensure early detection of issues.