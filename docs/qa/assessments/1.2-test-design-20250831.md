# Test Design: Story 1.2 - Script Text Parser

Date: 2025-08-31
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 36
- Unit tests: 20 (56%)
- Integration tests: 11 (30%)
- E2E tests: 5 (14%)
- Priority distribution: P0: 15, P1: 13, P2: 8

## Test Scenarios by Acceptance Criteria

### AC1: 能够解析纯文本格式的剧本输入

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 1.2-UNIT-001 | Unit | P0 | Parse valid plain text script | Core functionality |
| 1.2-UNIT-002 | Unit | P0 | Handle empty input gracefully | Edge case handling |
| 1.2-UNIT-003 | Unit | P0 | Reject binary file formats | Input validation |
| 1.2-INT-001 | Integration | P0 | Parse .txt file upload | File handling flow |
| 1.2-INT-002 | Integration | P1 | Parse pasted text input | User input flow |
| 1.2-E2E-001 | E2E | P1 | Complete text parsing workflow | Critical user journey |

### AC2: 能够识别和提取场景标题/描述

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 1.2-UNIT-004 | Unit | P0 | Identify "场景X:" pattern | Chinese format |
| 1.2-UNIT-005 | Unit | P0 | Identify "INT./EXT." pattern | English format |
| 1.2-UNIT-006 | Unit | P1 | Extract scene descriptions | Data extraction |
| 1.2-UNIT-007 | Unit | P2 | Handle mixed scene formats | Format flexibility |
| 1.2-INT-003 | Integration | P0 | Parse multiple scenes in sequence | Multi-scene handling |
| 1.2-INT-004 | Integration | P1 | Handle scene transitions | Scene flow |

### AC3: 能够识别和提取角色名称

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 1.2-UNIT-008 | Unit | P0 | Identify "角色名:" pattern | Chinese dialogue |
| 1.2-UNIT-009 | Unit | P0 | Identify "CHARACTER:" pattern | English dialogue |
| 1.2-UNIT-010 | Unit | P1 | Build character index | Data organization |
| 1.2-UNIT-011 | Unit | P2 | Handle character aliases | Advanced parsing |
| 1.2-INT-005 | Integration | P0 | Extract all unique characters | Character collection |

### AC4: 能够区分对话和动作描述

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 1.2-UNIT-012 | Unit | P0 | Identify dialogue after character name | Core parsing |
| 1.2-UNIT-013 | Unit | P0 | Identify action in parentheses | Action detection |
| 1.2-UNIT-014 | Unit | P1 | Distinguish narration from dialogue | Content classification |
| 1.2-INT-006 | Integration | P0 | Parse mixed dialogue and actions | Complex content |
| 1.2-INT-007 | Integration | P2 | Handle stage directions | Theater format |

### AC5: 输出结构化的剧本数据格式供AI分析使用

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 1.2-UNIT-015 | Unit | P0 | Generate valid JSON structure | Output format |
| 1.2-UNIT-016 | Unit | P0 | Include all required metadata | Data completeness |
| 1.2-UNIT-017 | Unit | P1 | Validate output schema | Schema compliance |
| 1.2-INT-008 | Integration | P0 | Export complete parsed script | Full output flow |
| 1.2-E2E-002 | E2E | P1 | AI service consumes output | Integration point |

### AC6: 支持中文和英文剧本解析

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 1.2-UNIT-018 | Unit | P0 | Parse Chinese script correctly | Language support |
| 1.2-UNIT-019 | Unit | P0 | Parse English script correctly | Language support |
| 1.2-UNIT-020 | Unit | P0 | Handle mixed Chinese/English | Bilingual content |
| 1.2-INT-009 | Integration | P0 | Detect language automatically | Language detection |
| 1.2-INT-010 | Integration | P1 | Handle UTF-8 encoding | Encoding support |
| 1.2-INT-011 | Integration | P2 | Handle other encodings (GB2312) | Legacy support |
| 1.2-E2E-003 | E2E | P1 | Parse real Chinese script | Real-world validation |
| 1.2-E2E-004 | E2E | P1 | Parse real English script | Real-world validation |
| 1.2-E2E-005 | E2E | P2 | Parse bilingual script | Complex scenario |

## Security Test Scenarios (Risk Mitigation)

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 1.2-SEC-001 | Integration | P0 | Reject script tags in input | XSS prevention |
| 1.2-SEC-002 | Integration | P0 | Sanitize HTML entities | Injection prevention |
| 1.2-SEC-003 | Integration | P0 | Validate file upload paths | Path traversal |
| 1.2-SEC-004 | Unit | P0 | Escape special characters | Output safety |

## Risk Coverage Matrix

Mapping test scenarios to identified risks from risk profile:

| Risk ID | Risk Title | Mitigating Test Scenarios |
|---------|------------|--------------------------|
| SEC-001 | Script injection vulnerability | 1.2-SEC-001, 1.2-SEC-002, 1.2-SEC-004 |
| SEC-002 | Path traversal in uploads | 1.2-SEC-003, 1.2-INT-001 |
| TECH-001 | Complex parsing logic | 1.2-UNIT-004 through 1.2-UNIT-014 |
| PERF-001 | Large script performance | Performance test suite (see below) |
| DATA-001 | Character encoding issues | 1.2-INT-010, 1.2-INT-011, 1.2-UNIT-020 |

## Test Data Requirements

### Sample Scripts

#### Chinese Script Sample
```text
场景1：办公室 - 日 - 内

张三：（焦急地）我们必须在今天完成这个项目！
李四：但是时间太紧了，质量可能会有问题。
（张三在房间里来回踱步）
张三：质量和时间，我们必须找到平衡点。
```

#### English Script Sample
```text
INT. OFFICE - DAY

JOHN: (anxiously) We must finish this project today!
MARY: But the timeline is too tight, quality might suffer.
(John paces around the room)
JOHN: Quality and time, we need to find the balance.
```

#### Mixed Language Sample
```text
场景2: COFFEE SHOP - 下午

小王: 你看过那个new movie吗？
EMMA: 没有呢，听说it's really good。
（两人坐下来喝咖啡）
```

#### Malicious Input Samples
```text
<script>alert('XSS')</script>
场景1：<img src=x onerror=alert('XSS')>
角色：'; DROP TABLE scripts; --
```

### Edge Cases
- Empty script
- Script with only scenes, no dialogue
- Script with only dialogue, no scenes
- Very long character names
- Nested parentheses in actions
- Multiple speakers in one line
- Scripts with 1000+ scenes

### Encoding Test Files
- UTF-8 with BOM
- UTF-8 without BOM
- GB2312 Chinese encoding
- Big5 Traditional Chinese
- ISO-8859-1 with special characters

## Performance Test Suite

| Test | Target | Acceptance Criteria |
|------|--------|-------------------|
| Parse 10-page script | < 1 second | Response time |
| Parse 100-page script | < 5 seconds | Response time |
| Parse 500-page script | < 30 seconds | Response time |
| Memory usage for 100-page | < 50MB | Resource usage |
| Concurrent parsing (10 scripts) | No failures | Reliability |

## Recommended Execution Order

### Phase 1: Security & Critical Path (P0 Tests)
1. **Security Tests** (Run first - gate criteria)
   - 1.2-SEC-001 through 1.2-SEC-004

2. **Unit Tests** (Core parsing logic)
   - 1.2-UNIT-001 through 1.2-UNIT-003
   - 1.2-UNIT-004, 1.2-UNIT-005 (Scene parsing)
   - 1.2-UNIT-008, 1.2-UNIT-009 (Character parsing)
   - 1.2-UNIT-012, 1.2-UNIT-013 (Dialogue/Action)
   - 1.2-UNIT-015, 1.2-UNIT-016 (Output format)
   - 1.2-UNIT-018, 1.2-UNIT-019, 1.2-UNIT-020 (Language)

3. **Integration Tests**
   - 1.2-INT-001 (File upload)
   - 1.2-INT-003, 1.2-INT-005, 1.2-INT-006 (Core parsing)
   - 1.2-INT-008, 1.2-INT-009 (Output & language)

### Phase 2: Core Functionality (P1 Tests)
- Remaining P1 unit tests
- P1 integration tests
- E2E tests 1.2-E2E-001 through 1.2-E2E-004

### Phase 3: Enhanced Features (P2 Tests)
- Advanced format handling
- Edge cases
- Bilingual script support

## Test Automation Strategy

### Unit Tests (Jest)
```typescript
describe('ScriptParser', () => {
  describe('Text Preprocessing', () => {
    // 1.2-UNIT-001 through 1.2-UNIT-003
  });
  
  describe('Scene Parsing', () => {
    // 1.2-UNIT-004 through 1.2-UNIT-007
  });
  
  describe('Character & Dialogue', () => {
    // 1.2-UNIT-008 through 1.2-UNIT-014
  });
  
  describe('Output Generation', () => {
    // 1.2-UNIT-015 through 1.2-UNIT-017
  });
  
  describe('Language Support', () => {
    // 1.2-UNIT-018 through 1.2-UNIT-020
  });
});
```

### Integration Tests (Jest)
```typescript
describe('Script Parser Integration', () => {
  describe('Security', () => {
    // 1.2-SEC-001 through 1.2-SEC-004
  });
  
  describe('File Processing', () => {
    // 1.2-INT-001 through 1.2-INT-011
  });
});
```

### E2E Tests (Playwright)
```typescript
describe('Script Parsing E2E', () => {
  // 1.2-E2E-001 through 1.2-E2E-005
});
```

## Quality Checklist

- ✅ Every AC has test coverage
- ✅ Test levels are appropriate (56% unit, 30% integration, 14% E2E)
- ✅ No duplicate coverage across levels
- ✅ Security risks addressed with P0 tests
- ✅ Performance criteria defined
- ✅ Test IDs follow naming convention
- ✅ Scenarios are atomic and independent

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 36
  by_level:
    unit: 20
    integration: 11
    e2e: 5
  by_priority:
    p0: 15
    p1: 13
    p2: 8
  security_tests: 4
  coverage_gaps: []
  risk_coverage:
    critical_risks: 100%
    high_risks: 100%
```

## Summary

This test design provides comprehensive coverage for the Script Text Parser story with:
- Strong security focus (4 dedicated security tests)
- Extensive unit testing (56%) for parsing logic
- Critical language support validation
- Performance benchmarks for large scripts
- Clear execution priorities based on risk

The design addresses all identified risks, particularly the critical script injection vulnerability and complex parsing requirements.

Test design matrix location: `docs/qa/assessments/1.2-test-design-20250831.md`
P0 tests identified: 15