# Test Design: Story 3.3 - 实现核心业务API端点

Date: 2025-01-09
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 86
- Unit tests: 38 (44%)
- Integration tests: 32 (37%)
- E2E tests: 16 (19%)
- Priority distribution: P0: 28, P1: 35, P2: 18, P3: 5

## Test Execution Strategy

### Phase 1: Foundation Tests (P0 Unit)
Execute first for rapid feedback on core logic validation

### Phase 2: Integration Validation (P0 Integration)
Verify component interactions and database operations

### Phase 3: Critical Path Verification (P0 E2E)
Validate complete user journeys and security boundaries

### Phase 4: Extended Coverage (P1-P3)
Additional scenarios based on available time

## Test Scenarios by Acceptance Criteria

### AC1: POST /api/projects - 创建项目

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 3.3-UNIT-001 | Unit | P0 | Validate project title (min/max length) | Pure validation logic |
| 3.3-UNIT-002 | Unit | P0 | Validate required fields presence | Input validation |
| 3.3-UNIT-003 | Unit | P1 | Sanitize HTML/script injection in content | Security validation |
| 3.3-UNIT-004 | Unit | P1 | Validate content size < 10MB | Business rule |
| 3.3-INT-001 | Integration | P0 | Create project with valid data | Core functionality |
| 3.3-INT-002 | Integration | P0 | Reject duplicate project titles for same user | Data integrity |
| 3.3-INT-003 | Integration | P0 | Handle database connection failure | Error handling |
| 3.3-INT-004 | Integration | P1 | Create project with Unicode characters | Internationalization |
| 3.3-E2E-001 | E2E | P0 | Authenticated user creates project | Critical path |
| 3.3-E2E-002 | E2E | P0 | Unauthenticated request rejected (401) | Security boundary |
| 3.3-E2E-003 | E2E | P1 | Create project with maximum allowed content | Boundary testing |

#### Test Data Requirements
- Valid project: `{ title: "Test Project", description: "Description", content: "Script content" }`
- Invalid title: Empty string, 201+ characters, special characters only
- Large content: 10MB+ payload
- Injection attempts: `<script>alert('XSS')</script>`, SQL injection patterns

### AC2: GET /api/projects - 获取用户项目列表

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 3.3-UNIT-005 | Unit | P0 | Parse pagination parameters (limit, offset) | Parameter validation |
| 3.3-UNIT-006 | Unit | P1 | Validate limit bounds (1-100) | Business rule |
| 3.3-UNIT-007 | Unit | P2 | Default pagination values | Default behavior |
| 3.3-INT-005 | Integration | P0 | Retrieve user's own projects only | Authorization |
| 3.3-INT-006 | Integration | P0 | Apply pagination correctly | Data retrieval |
| 3.3-INT-007 | Integration | P1 | Sort projects by creation date (desc) | User experience |
| 3.3-INT-008 | Integration | P1 | Handle empty project list | Edge case |
| 3.3-INT-009 | Integration | P2 | Retrieve with offset beyond total | Boundary case |
| 3.3-E2E-004 | E2E | P0 | List projects for authenticated user | Core journey |
| 3.3-E2E-005 | E2E | P1 | Pagination through multiple pages | User workflow |

#### Test Data Requirements
- User with 0 projects
- User with 1 project
- User with 50+ projects (pagination testing)
- Multiple users with projects (isolation testing)

### AC3: POST /api/analysis - 启动分析（异步）

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 3.3-UNIT-008 | Unit | P0 | Validate projectId format (CUID) | Input validation |
| 3.3-UNIT-009 | Unit | P0 | Validate scriptContent presence | Required field |
| 3.3-UNIT-010 | Unit | P0 | Generate unique analysisId | ID generation |
| 3.3-UNIT-011 | Unit | P1 | Validate script content size limit | Resource protection |
| 3.3-INT-010 | Integration | P0 | Create analysis record with pending status | State management |
| 3.3-INT-011 | Integration | P0 | Verify project ownership before analysis | Authorization |
| 3.3-INT-012 | Integration | P0 | Return 202 Accepted immediately | Async pattern |
| 3.3-INT-013 | Integration | P0 | Handle non-existent projectId | Error handling |
| 3.3-INT-014 | Integration | P1 | Queue analysis for background processing | Async workflow |
| 3.3-INT-015 | Integration | P1 | Handle concurrent analysis requests | Concurrency |
| 3.3-INT-016 | Integration | P2 | Rate limit analysis requests per user | Resource protection |
| 3.3-E2E-006 | E2E | P0 | Submit analysis for owned project | Critical path |
| 3.3-E2E-007 | E2E | P0 | Reject analysis for other user's project | Security |
| 3.3-E2E-008 | E2E | P1 | Submit multiple analyses rapidly | Load testing |

#### Test Data Requirements
- Valid CUID for projectId
- Invalid projectId formats
- Script content: minimal, typical, maximum size
- Malicious script content (injection attempts)

### AC4: GET /api/analysis/[id] - 获取分析结果

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 3.3-UNIT-012 | Unit | P0 | Validate analysis ID format | Input validation |
| 3.3-UNIT-013 | Unit | P2 | Format analysis response structure | Response formatting |
| 3.3-INT-017 | Integration | P0 | Retrieve pending analysis status | State query |
| 3.3-INT-018 | Integration | P0 | Retrieve completed analysis with results | Core functionality |
| 3.3-INT-019 | Integration | P0 | Return 404 for non-existent analysis | Error handling |
| 3.3-INT-020 | Integration | P0 | Verify analysis ownership | Authorization |
| 3.3-INT-021 | Integration | P1 | Retrieve failed analysis with error | Error state |
| 3.3-INT-022 | Integration | P1 | Handle processing status correctly | State machine |
| 3.3-INT-023 | Integration | P2 | Cache completed analysis results | Performance |
| 3.3-E2E-009 | E2E | P0 | Poll analysis until completion | User workflow |
| 3.3-E2E-010 | E2E | P0 | Unauthorized access returns 403 | Security |

#### Test Data Requirements
- Analysis in various states: pending, processing, completed, failed
- Analysis with large result set
- Recently completed vs old analysis (cache testing)

### AC5: PATCH /api/analysis/[id] - 更新分析

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 3.3-UNIT-014 | Unit | P0 | Validate action enum (accept/reject) | Input validation |
| 3.3-UNIT-015 | Unit | P1 | Validate suggestions array format | Data structure |
| 3.3-UNIT-016 | Unit | P2 | Validate suggestion string format | Data validation |
| 3.3-INT-024 | Integration | P0 | Accept analysis suggestions | Core functionality |
| 3.3-INT-025 | Integration | P0 | Reject analysis suggestions | Core functionality |
| 3.3-INT-026 | Integration | P0 | Verify ownership before update | Authorization |
| 3.3-INT-027 | Integration | P1 | Update only completed analyses | State validation |
| 3.3-INT-028 | Integration | P1 | Partial acceptance of suggestions | Business logic |
| 3.3-INT-029 | Integration | P2 | Audit trail for updates | Compliance |
| 3.3-E2E-011 | E2E | P0 | Accept suggestions workflow | User journey |
| 3.3-E2E-012 | E2E | P1 | Reject and re-analyze workflow | Alternative path |

#### Test Data Requirements
- Completed analysis with multiple suggestions
- Accept/reject action payloads
- Invalid suggestion IDs
- Mixed accept/reject selections

### AC6: GET /api/export/[projectId] - 导出项目

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 3.3-UNIT-017 | Unit | P0 | Validate projectId format | Input validation |
| 3.3-UNIT-018 | Unit | P1 | Determine export format from headers | Content negotiation |
| 3.3-UNIT-019 | Unit | P1 | Generate JSON export structure | Data formatting |
| 3.3-UNIT-020 | Unit | P1 | Generate Markdown export | Alternative format |
| 3.3-INT-030 | Integration | P0 | Export owned project data | Core functionality |
| 3.3-INT-031 | Integration | P0 | Include all project analyses in export | Data completeness |
| 3.3-INT-032 | Integration | P0 | Verify project ownership | Authorization |
| 3.3-INT-033 | Integration | P1 | Stream large exports | Performance |
| 3.3-INT-034 | Integration | P2 | Set appropriate response headers | HTTP compliance |
| 3.3-E2E-013 | E2E | P0 | Download project export | User journey |
| 3.3-E2E-014 | E2E | P1 | Export in different formats | Feature validation |
| 3.3-E2E-015 | E2E | P2 | Export very large project | Stress testing |

#### Test Data Requirements
- Small project (< 1MB export)
- Large project (> 10MB export)
- Project with multiple analyses
- Project with no analyses

## Cross-Cutting Concerns Testing

### Authentication & Authorization

| ID | Level | Priority | Test | Risk Mitigation |
|----|-------|----------|------|-----------------|
| 3.3-UNIT-021 | Unit | P0 | Parse JWT token | SEC-001 |
| 3.3-UNIT-022 | Unit | P0 | Validate token expiry | SEC-001 |
| 3.3-INT-035 | Integration | P0 | All endpoints require auth | SEC-001 |
| 3.3-INT-036 | Integration | P0 | Cross-user resource access denied | SEC-003 |
| 3.3-E2E-016 | E2E | P0 | Session timeout handling | SEC-001 |

### Error Handling

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 3.3-UNIT-023 | Unit | P0 | Format error responses consistently | API contract |
| 3.3-UNIT-024 | Unit | P1 | Include request ID in errors | Debugging |
| 3.3-INT-037 | Integration | P0 | Database connection errors | Resilience |
| 3.3-INT-038 | Integration | P1 | AI service timeout handling | TECH-001 |

### Performance

| ID | Level | Priority | Test | Risk Mitigation |
|----|-------|----------|------|-----------------|
| 3.3-UNIT-025 | Unit | P2 | Response serialization < 10ms | PERF-003 |
| 3.3-INT-039 | Integration | P0 | Database queries < 100ms | PERF-001 |
| 3.3-INT-040 | Integration | P1 | API response < 500ms | PERF-003 |
| 3.3-INT-041 | Integration | P2 | Concurrent request handling | PERF-003 |

### Security

| ID | Level | Priority | Test | Risk Mitigation |
|----|-------|----------|------|-----------------|
| 3.3-UNIT-026 | Unit | P0 | SQL injection prevention | SEC-002 |
| 3.3-UNIT-027 | Unit | P0 | XSS prevention in responses | SEC-002 |
| 3.3-UNIT-028 | Unit | P0 | Path traversal prevention | SEC-002 |
| 3.3-INT-042 | Integration | P0 | Rate limiting enforcement | SEC-005 |
| 3.3-INT-043 | Integration | P1 | CORS configuration | SEC-004 |

## Risk Coverage Matrix

| Risk ID | Test Scenarios | Coverage Level |
|---------|---------------|----------------|
| SEC-001 (Missing Auth) | 3.3-UNIT-021/022, 3.3-INT-035, 3.3-E2E-002/016 | High |
| SEC-002 (Input Validation) | 3.3-UNIT-001/003/026/027/028 | High |
| DATA-001 (Async State) | 3.3-INT-010/017/018/021/022 | Medium |
| SEC-003 (Authorization) | 3.3-INT-005/011/020/026/032/036 | High |
| PERF-001 (DB Queries) | 3.3-INT-039 | Medium |
| SEC-004 (CORS) | 3.3-INT-043 | Low |
| SEC-005 (Rate Limiting) | 3.3-INT-016/042 | Medium |

## Test Data Management

### Required Test Users
1. User A: Owner of multiple projects
2. User B: Different user for cross-access testing
3. User C: Rate-limited user
4. Admin User: For administrative operations

### Required Test Projects
1. Small project (minimal data)
2. Large project (stress testing)
3. Project with completed analyses
4. Project with pending analyses
5. Archived/deleted project

### Test Database State
- Reset between test suites
- Seed data for consistent testing
- Transaction rollback for integration tests

## Recommended Execution Order

### Phase 1: Critical Security (Must Pass)
1. All P0 Unit tests (SEC-001, SEC-002, SEC-003)
2. Authentication/Authorization integration tests
3. Security E2E tests

### Phase 2: Core Functionality
1. P0 Integration tests for CRUD operations
2. P0 E2E tests for user journeys
3. Async workflow tests

### Phase 3: Extended Coverage
1. P1 Unit and Integration tests
2. Performance tests
3. Error handling scenarios

### Phase 4: Nice to Have
1. P2/P3 tests
2. Stress testing
3. Chaos engineering

## Test Environment Requirements

### Unit Test Environment
- Mocked dependencies
- In-memory database
- Stubbed AI service

### Integration Test Environment
- Test database instance
- Mock AI service with predictable responses
- Authentication bypass for testing

### E2E Test Environment
- Full stack deployment
- Separate test database
- Test user accounts
- Rate limiting configured

## Success Criteria

### Minimum for Development Complete
- 100% of P0 tests passing
- 90% of P1 tests passing
- No critical security failures

### Ready for Staging
- All P0 and P1 tests passing
- Performance tests meeting SLA
- Security scan clean

### Production Ready
- All tests passing
- Load testing completed
- Security audit passed
- Monitoring configured

## Maintenance Considerations

### Test Stability
- Avoid time-dependent tests
- Use deterministic test data
- Implement proper test isolation

### Test Performance
- Unit tests < 100ms each
- Integration tests < 1s each
- E2E tests < 5s each
- Full suite < 5 minutes

### Test Documentation
- Clear test names describing behavior
- Comments for complex scenarios
- Failure messages with context