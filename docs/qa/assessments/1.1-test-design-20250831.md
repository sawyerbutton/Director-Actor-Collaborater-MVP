# Test Design: Story 1.1 - DeepSeek API Integration

Date: 2025-08-31
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 28
- Unit tests: 15 (54%)
- Integration tests: 9 (32%)
- E2E tests: 4 (14%)
- Priority distribution: P0: 12, P1: 10, P2: 6

## Test Scenarios by Acceptance Criteria

### AC1: 能够成功连接DeepSeek API并发送请求

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 1.1-UNIT-001 | Unit | P0 | Validate API endpoint URL format | Pure validation logic |
| 1.1-UNIT-002 | Unit | P0 | Validate API key format and presence | Security-critical validation |
| 1.1-INT-001 | Integration | P0 | Successful API connection with valid credentials | Multi-component interaction |
| 1.1-INT-002 | Integration | P0 | Handle invalid API key error | Error path validation |
| 1.1-INT-003 | Integration | P1 | Handle network timeout | Resilience testing |
| 1.1-E2E-001 | E2E | P1 | Complete request-response cycle | Critical user journey |

### AC2: 实现统一的错误处理和重试机制

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 1.1-UNIT-003 | Unit | P0 | Calculate exponential backoff delays | Algorithm testing |
| 1.1-UNIT-004 | Unit | P1 | Validate max retry limit enforcement | Boundary condition |
| 1.1-UNIT-005 | Unit | P0 | Custom error class instantiation | Object creation logic |
| 1.1-INT-004 | Integration | P0 | Retry on transient failures (500, 502, 503) | Network resilience |
| 1.1-INT-005 | Integration | P1 | No retry on client errors (400, 401, 403) | Efficient error handling |
| 1.1-INT-006 | Integration | P2 | Circuit breaker activation after failures | Advanced resilience |

### AC3: 支持配置API密钥和端点

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 1.1-UNIT-006 | Unit | P0 | Load configuration from environment variables | Config parsing |
| 1.1-UNIT-007 | Unit | P0 | Validate required configuration presence | Startup validation |
| 1.1-UNIT-008 | Unit | P1 | Handle missing optional configuration | Graceful defaults |
| 1.1-INT-007 | Integration | P1 | Configuration hot-reload detection | Runtime flexibility |
| 1.1-E2E-002 | E2E | P2 | Configuration through UI settings | User configuration |

### AC4: 提供类型安全的请求和响应接口

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 1.1-UNIT-009 | Unit | P0 | TypeScript type validation for requests | Compile-time safety |
| 1.1-UNIT-010 | Unit | P0 | Response schema validation | Runtime type safety |
| 1.1-UNIT-011 | Unit | P1 | Handle unexpected response fields | Defensive programming |
| 1.1-UNIT-012 | Unit | P2 | Generate TypeScript types from OpenAPI spec | Development efficiency |
| 1.1-INT-008 | Integration | P1 | Validate actual API response matches types | Contract testing |

### AC5: 包含基本的速率限制处理

#### Scenarios

| ID | Level | Priority | Test | Justification |
|----|-------|----------|------|---------------|
| 1.1-UNIT-013 | Unit | P0 | Queue management logic | Core algorithm |
| 1.1-UNIT-014 | Unit | P1 | Priority queue ordering | Feature logic |
| 1.1-UNIT-015 | Unit | P2 | Queue size limits | Resource management |
| 1.1-INT-009 | Integration | P0 | Handle 429 rate limit response | API compliance |
| 1.1-E2E-003 | E2E | P1 | Graceful degradation under rate limits | User experience |
| 1.1-E2E-004 | E2E | P2 | Queue status visibility | Observability |

## Risk Coverage Matrix

Mapping test scenarios to identified risks from risk profile:

| Risk ID | Risk Title | Mitigating Test Scenarios |
|---------|------------|--------------------------|
| SEC-001 | API key exposure | 1.1-UNIT-002, 1.1-UNIT-006, 1.1-UNIT-007 |
| SEC-002 | Response injection | 1.1-UNIT-010, 1.1-UNIT-011, 1.1-INT-008 |
| PERF-001 | Rate limiting | 1.1-UNIT-013, 1.1-UNIT-014, 1.1-INT-009, 1.1-E2E-003 |
| TECH-001 | Vendor lock-in | (Addressed by abstraction layer design, not direct tests) |
| DATA-001 | Data loss | 1.1-INT-004, 1.1-INT-005 |
| OPS-001 | Monitoring gaps | 1.1-E2E-004 |

## Test Data Requirements

### Environment Variables
```env
# Valid test configuration
DEEPSEEK_API_KEY=test_valid_key_123456789
DEEPSEEK_API_URL=https://api.deepseek.com/v1
DEEPSEEK_TIMEOUT=5000
DEEPSEEK_MAX_RETRIES=3

# Invalid configurations for negative testing
DEEPSEEK_API_KEY_INVALID=invalid
DEEPSEEK_API_URL_MALFORMED=not-a-url
```

### Mock API Responses
```typescript
// Success response
{
  "id": "test-response-001",
  "model": "deepseek-chat",
  "choices": [{
    "message": {
      "role": "assistant",
      "content": "Test response content"
    }
  }]
}

// Rate limit response
{
  "error": {
    "code": "rate_limit_exceeded",
    "message": "Too many requests"
  }
}

// Server error response
{
  "error": {
    "code": "internal_server_error",
    "message": "Service temporarily unavailable"
  }
}
```

### Test Payloads
```typescript
// Valid request
{
  "model": "deepseek-chat",
  "messages": [
    {"role": "user", "content": "Test prompt"}
  ],
  "temperature": 0.7
}

// Invalid request (missing required fields)
{
  "messages": []
}

// Malicious payload (injection attempt)
{
  "model": "deepseek-chat",
  "messages": [
    {"role": "user", "content": "<script>alert('xss')</script>"}
  ]
}
```

## Recommended Execution Order

### Phase 1: Critical Path (P0 Tests)
1. **Unit Tests** (Run first, fail fast)
   - 1.1-UNIT-001: API endpoint validation
   - 1.1-UNIT-002: API key validation
   - 1.1-UNIT-003: Backoff calculation
   - 1.1-UNIT-005: Error classes
   - 1.1-UNIT-006: Config loading
   - 1.1-UNIT-007: Config validation
   - 1.1-UNIT-009: TypeScript types
   - 1.1-UNIT-010: Response validation
   - 1.1-UNIT-013: Queue logic

2. **Integration Tests**
   - 1.1-INT-001: API connection
   - 1.1-INT-002: Invalid key handling
   - 1.1-INT-004: Retry mechanism
   - 1.1-INT-009: Rate limit handling

### Phase 2: Core Functionality (P1 Tests)
1. **Unit Tests**
   - 1.1-UNIT-004: Retry limits
   - 1.1-UNIT-008: Optional config
   - 1.1-UNIT-011: Unexpected fields
   - 1.1-UNIT-014: Priority queue

2. **Integration Tests**
   - 1.1-INT-003: Timeout handling
   - 1.1-INT-005: No retry on client errors
   - 1.1-INT-007: Config reload
   - 1.1-INT-008: Response contract

3. **E2E Tests**
   - 1.1-E2E-001: Complete cycle
   - 1.1-E2E-003: Rate limit UX

### Phase 3: Enhanced Features (P2 Tests)
- 1.1-UNIT-012: Type generation
- 1.1-UNIT-015: Queue limits
- 1.1-INT-006: Circuit breaker
- 1.1-E2E-002: UI configuration
- 1.1-E2E-004: Queue visibility

## Test Automation Strategy

### Unit Tests (Jest)
```typescript
// Location: __tests__/lib/api/deepseek/
describe('DeepSeekClient', () => {
  describe('Configuration', () => {
    // 1.1-UNIT-001 through 1.1-UNIT-008
  });
  
  describe('Type Safety', () => {
    // 1.1-UNIT-009 through 1.1-UNIT-012
  });
  
  describe('Rate Limiting', () => {
    // 1.1-UNIT-013 through 1.1-UNIT-015
  });
});
```

### Integration Tests (Jest + MSW)
```typescript
// Mock Service Worker for API simulation
describe('DeepSeek API Integration', () => {
  // 1.1-INT-001 through 1.1-INT-009
});
```

### E2E Tests (Playwright)
```typescript
// Critical user journeys
describe('DeepSeek Integration E2E', () => {
  // 1.1-E2E-001 through 1.1-E2E-004
});
```

## Quality Checklist

- ✅ Every AC has test coverage
- ✅ Test levels are appropriate (54% unit, 32% integration, 14% E2E)
- ✅ No duplicate coverage across levels
- ✅ Priorities align with identified risks
- ✅ Test IDs follow naming convention
- ✅ Scenarios are atomic and independent
- ✅ Risk mitigation coverage verified

## Gate YAML Block

```yaml
test_design:
  scenarios_total: 28
  by_level:
    unit: 15
    integration: 9
    e2e: 4
  by_priority:
    p0: 12
    p1: 10
    p2: 6
  coverage_gaps: []
  risk_coverage:
    critical_risks: 100%
    high_risks: 100%
```

## Summary

This test design provides comprehensive coverage for the DeepSeek API integration story with:
- Strong focus on unit testing (54%) for fast feedback
- Critical security risks covered by P0 tests
- Performance risks addressed through rate limiting tests
- Type safety validated at multiple levels
- Clear execution priorities based on risk

Test design matrix location: `docs/qa/assessments/1.1-test-design-20250831.md`
P0 tests identified: 12