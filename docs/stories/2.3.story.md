# Story 2.3: 实现核心交互功能并导出结果

## Status
Done

## Story
**As a** 剧本创作者,
**I want** 能够对AI提供的修改建议进行接受或拒绝操作，并导出包含已接受修改的新版本剧本,
**so that** 我可以根据自己的判断选择性地应用AI建议，并获得改进后的剧本文件

## Acceptance Criteria
1. 用户能够对每个错误的修改建议进行"接受"或"拒绝"操作
2. 接受/拒绝状态必须实时更新并在UI中清晰显示
3. 系统必须追踪所有接受的修改并能够应用到原始剧本
4. 用户能够预览应用修改后的剧本内容
5. 用户能够导出包含已接受修改的新版本剧本（支持.txt和.docx格式）
6. 导出的剧本必须保持原始格式和结构，仅应用接受的修改
7. 系统必须提供撤销/重做功能for接受/拒绝操作

## Tasks / Subtasks
- [x] Task 1: 实现修改建议交互组件 (AC: 1, 2)
  - [x] 创建suggestion-card组件with接受/拒绝按钮
  - [x] 实现建议状态管理（pending/accepted/rejected）
  - [x] 添加视觉反馈for不同状态（颜色、图标、动画）
  - [x] 集成到现有错误展示组件中
- [x] Task 2: 实现修改追踪和应用系统 (AC: 3, 7)
  - [x] 扩展store添加修改追踪状态
  - [x] 实现修改历史堆栈for撤销/重做
  - [x] 创建修改应用服务计算最终剧本内容
  - [x] 处理修改冲突和依赖关系
- [x] Task 3: 实现剧本预览功能 (AC: 4)
  - [x] 创建剧本预览组件with diff高亮
  - [x] 实现实时预览更新when修改状态改变
  - [x] 添加原始/修改后对比视图
  - [x] 实现预览模式切换（仅修改/完整剧本）
- [x] Task 4: 实现导出功能 (AC: 5, 6)
  - [x] 创建导出服务处理不同格式
  - [x] 实现.txt格式导出保持原始格式
  - [x] 实现.docx格式导出使用适当样式
  - [x] 添加导出选项对话框（格式选择、文件名等）
- [x] Task 5: 实现撤销/重做功能 (AC: 7)
  - [x] 创建undo/redo操作栏组件
  - [x] 实现命令模式for操作历史
  - [x] 添加键盘快捷键支持（Ctrl+Z/Ctrl+Y）
  - [x] 处理批量操作的撤销/重做
- [x] Task 6: 集成和优化 (AC: 2, 6)
  - [x] 确保状态同步across所有相关组件
  - [x] 优化性能for大量修改操作
  - [x] 添加加载状态和错误处理
  - [x] 实现自动保存草稿功能
- [x] Task 7: 编写测试 (AC: 所有)
  - [x] 为交互组件编写单元测试
  - [x] 为修改应用逻辑编写测试
  - [x] 为导出功能编写集成测试
  - [x] 编写E2E测试for完整用户流程

## Dev Notes

### 技术栈信息
[Source: architecture/tech-stack.md]
- **前端框架**: Next.js 14.x
- **UI组件库**: shadcn/ui (latest)
- **样式**: Tailwind CSS 3.x
- **状态管理**: Zustand
- **测试框架**: Jest + React Testing Library, Playwright

### 项目结构
[Source: architecture/source-tree.md]
- 采用清晰的单体仓库文件结构
- 分离`app/` (UI/路由)和`lib/` (核心逻辑)
- 通过`types/`共享类型定义

### 文件位置
基于现有项目结构，新文件应创建在：
- `components/revision/` - 修改建议相关组件（新建）
- `components/revision/suggestion-card.tsx` - 建议卡片组件
- `components/revision/revision-controls.tsx` - 撤销/重做控制栏
- `components/revision/script-preview.tsx` - 剧本预览组件
- `components/revision/export-dialog.tsx` - 导出对话框
- `lib/services/revision-tracker.ts` - 修改追踪服务
- `lib/services/script-merger.ts` - 剧本合并服务
- `lib/services/export-service.ts` - 导出服务
- `lib/stores/revision-store.ts` - 修改状态管理（新建）
- `types/revision.ts` - 修改相关类型定义（已存在）

### 从Story 2.2学到的经验
[Source: docs/stories/2.2.story.md#dev-agent-record]
- 已实现完整的可视化组件体系using Recharts
- 已建立Zustand状态管理架构with analysis-store
- 已有完善的错误展示和上下文关联功能
- 性能优化策略：React.memo, useMemo, 虚拟滚动
- 安全考虑：使用DOMPurify进行内容消毒
- 已有shadcn/ui组件库基础（Button, Card, Badge, Dialog, Select等）

### 现有类型定义扩展
基于types/revision.ts，需要使用和扩展：
```typescript
// 现有的建议优先级常量
export const SuggestionPriority = {
  CRITICAL: 'critical',
  HIGH: 'high',
  MEDIUM: 'medium',
  LOW: 'low'
} as const;

// 需要添加的修改状态类型
interface RevisionState {
  status: 'pending' | 'accepted' | 'rejected';
  appliedAt?: Date;
  appliedBy?: string;
}

// 修改历史记录
interface RevisionHistory {
  action: 'accept' | 'reject' | 'undo' | 'redo';
  suggestionId: string;
  timestamp: Date;
  previousState: RevisionState;
  newState: RevisionState;
}
```

### 导出格式要求
- **.txt格式**: 保持原始文本格式，应用接受的修改，不添加额外标记
- **.docx格式**: 使用适当的样式（标题、段落、对话等），可选择性地高亮修改部分

### 交互设计要点
- 接受按钮：绿色，勾选图标
- 拒绝按钮：红色，叉号图标
- 已接受状态：绿色背景，半透明
- 已拒绝状态：灰色，删除线
- 撤销/重做：标准图标，工具提示显示操作内容
- 批量操作：全选/全部接受/全部拒绝with确认对话框

### 性能考虑
- 使用`immer`或类似库for不可变状态更新
- 批量修改操作使用事务模式
- 大文件导出使用Web Workers避免阻塞UI
- 实时预览使用防抖（debounce）优化

### 依赖库建议
- **docx**: 用于生成.docx文件
- **file-saver**: 用于文件下载
- **immer**: 用于不可变状态管理
- **diff**: 用于计算文本差异

### 可访问性要求
- 键盘导航支持for所有交互元素
- ARIA标签for屏幕阅读器
- 焦点管理for模态对话框
- 颜色不作为唯一的状态指示器

## Testing
[Source: architecture/15-测试策略.md]
- 采用精简的测试金字塔
- 重点投入在核心逻辑的单元测试
- 测试文件位置：`__tests__/components/revision/`目录
- 关键测试场景：
  - 接受/拒绝操作的状态更新
  - 撤销/重做功能的正确性
  - 修改冲突的处理
  - 导出文件的格式和内容正确性
- E2E测试：完整的修改-预览-导出流程

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-07 | v1.0 | Initial story creation | Bob (Scrum Master) |
| 2025-09-07 | v1.1 | Applied QA fixes: Type safety improvements and XSS vulnerability remediation | James (Dev) |

## Dev Agent Record

### Agent Model Used
claude-opus-4-1-20250805

### Debug Log References
- Task implementation tracked through TodoWrite tool
- All 7 tasks completed successfully
- 57 tests written and passing

### Completion Notes List
- Implemented complete revision system with suggestion cards, accept/reject functionality
- Added revision tracking and script merging services  
- Created script preview with diff visualization
- Implemented export functionality for .txt and .docx formats
- Added undo/redo with keyboard shortcuts (Ctrl+Z/Ctrl+Y)
- Integrated revision page with analysis results
- All acceptance criteria met
- Applied QA-identified fixes:
  - Fixed type safety issues by creating ExtendedError interface in suggestion-card.tsx
  - Resolved XSS vulnerability by adding DOMPurify sanitization in revision-tracker.ts
- All 57 tests passing with comprehensive coverage

### File List
**New Files Created:**
- components/revision/suggestion-card.tsx
- components/revision/revision-error-list.tsx
- components/revision/revision-controls.tsx
- components/revision/script-preview.tsx
- components/revision/export-dialog.tsx
- components/analysis/revision-link.tsx
- lib/stores/revision-store.ts
- lib/services/revision-tracker.ts
- lib/services/script-merger.ts
- lib/services/export-service.ts
- app/revision/page.tsx
- __tests__/components/revision/suggestion-card.test.tsx
- __tests__/components/revision/script-preview.test.tsx
- __tests__/lib/services/revision-tracker.test.ts
- __tests__/lib/services/export-service.test.ts
- __tests__/lib/stores/revision-store.test.ts
- __tests__/integration/revision-flow.test.tsx

**Modified Files:**
- lib/stores/analysis-store.ts (added errors getter and setErrors method)

## QA Results

### Review Date: 2025-09-07

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The implementation demonstrates **excellent architecture and separation of concerns** with a well-structured revision system. The code successfully implements all 7 acceptance criteria with comprehensive test coverage (95%+). The solution uses proper design patterns including Command Pattern for undo/redo, Service Layer abstraction, and immutable state management with Zustand and Immer.

### Refactoring Performed

- **File**: components/revision/suggestion-card.tsx
  - **Change**: Removed unsafe type casting with `as any` and created proper ExtendedError interface
  - **Why**: Type safety violations could cause runtime errors and lose TypeScript benefits
  - **How**: Created union types to handle different error formats properly, improving type safety and maintainability

- **File**: lib/services/revision-tracker.ts
  - **Change**: Added input sanitization using DOMPurify for all user-generated content
  - **Why**: Direct regex execution on unsanitized user input created XSS vulnerability
  - **How**: Wrapped all user inputs with DOMPurify.sanitize() to prevent script injection attacks

### Compliance Check

- Coding Standards: ✓ Well-structured, follows Next.js and TypeScript best practices
- Project Structure: ✓ Properly organized in components/, lib/, and app/ directories
- Testing Strategy: ✓ Comprehensive unit and integration tests with 95%+ coverage
- All ACs Met: ✓ All 7 acceptance criteria fully implemented and tested

### Requirements Traceability

**Given-When-Then Mapping:**

1. **AC1: Accept/Reject Operations**
   - Given: Errors displayed in suggestion cards
   - When: User clicks accept/reject buttons
   - Then: Status updates to accepted/rejected
   - Tests: suggestion-card.test.tsx, revision-flow.test.tsx

2. **AC2: Real-time Status Updates**
   - Given: User performs accept/reject action
   - When: Action is triggered
   - Then: UI immediately reflects new status with visual feedback
   - Tests: revision-flow.test.tsx (bulk operations)

3. **AC3: Modification Tracking**
   - Given: User accepts suggestions
   - When: System processes accepted changes
   - Then: RevisionTracker maintains all modifications
   - Tests: revision-tracker.test.ts (9 tests)

4. **AC4: Preview Functionality**
   - Given: Accepted modifications exist
   - When: User views preview
   - Then: Script shows with diff highlighting
   - Tests: script-preview.test.tsx

5. **AC5: Export Functionality**
   - Given: User has reviewed suggestions
   - When: Export is triggered
   - Then: Files generated in .txt/.docx formats
   - Tests: export-service.test.ts (13 tests)

6. **AC6: Format Preservation**
   - Given: Original script with formatting
   - When: Modifications applied and exported
   - Then: Original structure maintained
   - Tests: export-service.test.ts

7. **AC7: Undo/Redo**
   - Given: User has performed actions
   - When: Ctrl+Z/Ctrl+Y pressed
   - Then: Actions are undone/redone
   - Tests: revision-flow.test.tsx (keyboard shortcuts)

### Improvements Checklist

- [x] Fixed type safety issues in suggestion-card.tsx
- [x] Added input sanitization in revision-tracker.ts for XSS prevention
- [ ] Consider adding virtual scrolling for large error lists (1000+ items)
- [ ] Implement lazy loading for export functionality to reduce bundle size
- [ ] Add performance optimization with memoization for large script diffs
- [ ] Enhance conflict detection with semantic analysis
- [ ] Add error boundaries for import failures in export-dialog.tsx

### Security Review

**Critical Issues Fixed:**
- ✓ XSS vulnerability in revision-tracker.ts resolved with DOMPurify sanitization
- ✓ Type safety violations fixed to prevent runtime errors

**Remaining Considerations:**
- localStorage draft data is unencrypted (low risk for script content)
- No MIME type validation for exports (low risk, client-side only)

### Performance Considerations

**Current Performance:** Good
- React.memo and useMemo properly implemented
- Efficient state updates with Immer
- Debouncing implemented for preview updates

**Optimization Opportunities:**
- Virtual scrolling for 1000+ errors would improve rendering
- Code splitting for docx export library (currently loaded eagerly)
- Web Workers for large script processing could enhance UX

### Files Modified During Review

- components/revision/suggestion-card.tsx
- lib/services/revision-tracker.ts

### Gate Status

Gate: **PASS** → docs/qa/gates/2.3-实现核心交互功能并导出结果.yml
Risk profile: Low risk - Well-tested feature with security fixes applied
NFR assessment: Security and performance requirements met

### Recommended Status

✓ **Ready for Done** - All acceptance criteria met, critical issues fixed, comprehensive test coverage confirmed

Story owner may proceed to mark as Done.