# Story 1.5: 实现"修改执行官"与协作框架

## Status
Draft

## Story
**As a** 系统开发者,
**I want** 实现一个修改执行官Agent，能够生成针对性的修改建议，并建立Agent间的协作机制,
**so that** 系统能够不仅检测问题，还能提供具体可执行的修改方案，并确保多个Agent协同工作

## Acceptance Criteria
1. 为每个错误生成具体的修改建议
2. 实现Agent间的消息传递和协调
3. 确保建议的上下文相关性

## Tasks / Subtasks
- [ ] Task 1: 创建修改执行官(RevisionExecutive)Agent基础结构 (AC: 1)
  - [ ] 在lib/agents/下创建revision-executive.ts文件
  - [ ] 定义RevisionExecutiveConfig接口，继承自现有的AgentConfig模式
  - [ ] 实现RevisionExecutive类的基本构造器和配置
  - [ ] 集成DeepSeekClient用于AI处理
- [ ] Task 2: 实现修改建议生成功能 (AC: 1, 3)
  - [ ] 创建suggestion-generator方法，接收LogicError并生成修改建议
  - [ ] 实现上下文感知的建议生成（考虑场景、角色、对话上下文）
  - [ ] 为不同类型的错误（timeline, character, plot, dialogue, scene）创建专门的建议模板
  - [ ] 实现建议的优先级排序和可行性评估
- [ ] Task 3: 设计并实现Agent协作框架 (AC: 2)
  - [ ] 在lib/agents/下创建collaboration-framework.ts
  - [ ] 定义Agent间消息传递接口（AgentMessage, MessageType）
  - [ ] 实现Agent注册和发现机制
  - [ ] 创建消息队列和事件总线系统
  - [ ] 实现协作会话(CollaborationSession)管理
- [ ] Task 4: 集成ConsistencyGuardian与RevisionExecutive (AC: 2, 3)
  - [ ] 创建协作管道，让ConsistencyGuardian的错误输出直接传递给RevisionExecutive
  - [ ] 实现错误批处理和建议生成的异步处理
  - [ ] 确保建议与检测到的错误完全对应
  - [ ] 实现建议冲突检测和解决机制
- [ ] Task 5: 实现建议的验证和优化 (AC: 3)
  - [ ] 创建建议验证器，确保修改不会引入新的逻辑错误
  - [ ] 实现建议的上下文验证（检查是否符合角色性格、剧情发展等）
  - [ ] 集成IncrementalAnalysisEngine（来自Story 1.4）进行建议影响分析
  - [ ] 实现建议的合并和优化逻辑
- [ ] Task 6: 创建Agent协作的监控和日志 (AC: 2)
  - [ ] 实现协作会话的日志记录
  - [ ] 创建Agent间通信的追踪机制
  - [ ] 实现性能监控和瓶颈识别
  - [ ] 添加协作指标收集（响应时间、消息量、成功率）
- [ ] Task 7: 编写单元测试和集成测试 (AC: 所有)
  - [ ] 为RevisionExecutive编写单元测试
  - [ ] 为CollaborationFramework编写单元测试
  - [ ] 编写端到端的Agent协作集成测试
  - [ ] 测试错误处理和边缘情况
  - [ ] 验证性能要求（<10秒生成建议）

## Dev Notes

### 技术栈信息
[Source: architecture/2-技术栈.md]
- **语言**: TypeScript 5.x
- **后端框架**: Next.js API Routes 14.x
- **AI服务**: DeepSeek API v1
- **测试框架**: Jest + RTL, Playwright (latest)

### 项目结构
[Source: architecture/11-统一项目结构.md]
- 采用清晰的单体仓库文件结构
- 分离`app/` (UI/路由)和`lib/` (核心逻辑)
- 通过`types/`共享类型定义

### 文件位置
基于现有项目结构：
- `lib/agents/revision-executive.ts` - 修改执行官Agent实现
- `lib/agents/collaboration-framework.ts` - Agent协作框架
- `lib/agents/types.ts` - 已存在，需扩展新的类型定义
- `types/revision.d.ts` - 新建，定义修改建议相关类型
- `__tests__/lib/agents/revision-executive.test.ts` - 测试文件
- `__tests__/lib/agents/collaboration-framework.test.ts` - 测试文件

### 现有Agent架构
[Source: 代码分析]
- **ConsistencyGuardian类** (lib/agents/consistency-guardian.ts)：
  - 使用DeepSeekClient进行API调用
  - 实现了缓存机制和并发控制
  - 支持分块分析和批处理
  - 配置模式：ConsistencyAgentConfig

- **Agent类型系统** (lib/agents/types.ts)：
  - AgentPromptConfig：定义提示词配置
  - AgentResponse：标准化的Agent响应格式
  - ERROR_DETECTION_RULES：错误检测规则定义
  - DEFAULT_AGENT_CONFIG：默认配置

- **错误类型定义** (types/analysis.ts)：
  - LogicErrorType枚举：timeline, character, plot, dialogue, scene
  - ErrorSeverity枚举：critical, high, medium, low
  - LogicError接口：包含id, type, severity, location, description, suggestion

### 从Story 1.4学到的经验
[Source: docs/stories/1.4.story.md#dev-agent-record]
- 使用Map进行缓存时需要实现内存清理策略（限制100个脚本，1000个事件）
- 避免使用`any`类型，使用`unknown`或具体类型
- 为复杂算法添加JSDoc注释
- 实现并发控制（最多3个并发操作）
- 性能目标：<10秒完成分析

### Agent协作设计考虑
- 消息传递使用异步事件驱动模式
- 支持Agent注册和动态发现
- 实现幂等性确保消息处理的可靠性
- 使用队列管理避免消息丢失
- 协作会话需要超时机制（建议30秒）

### 建议生成策略
- 每个LogicError应该对应1-3个具体的修改建议
- 建议应包含：具体修改内容、修改位置、预期效果
- 优先级：critical错误的建议优先，按影响范围排序
- 建议格式应该是可直接应用的文本替换或添加

### Testing
[Source: architecture/15-测试策略.md]
- 采用精简的测试金字塔
- 重点投入在核心逻辑的单元测试
- 测试文件位置：`__tests__/lib/agents/`目录
- 使用Jest作为测试框架
- 确保测试覆盖率>90%
- 模拟DeepSeekClient避免测试中的实际API调用

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-03 | v1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used

### Debug Log References

### Completion Notes List

### File List

## QA Results