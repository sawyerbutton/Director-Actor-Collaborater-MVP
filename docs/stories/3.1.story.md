# Story 3.1: 搭建Next.js单体应用后端结构

## Status
Approved

## Story
**As a** 系统架构师,
**I want** 搭建一个基于Next.js API Routes的后端基础架构,
**so that** 系统能够处理API请求、管理中间件、并为后续的数据库和认证集成做好准备

## Acceptance Criteria
1. Next.js API Routes目录结构必须按RESTful规范组织
2. 环境变量管理系统必须配置完成（.env.local和类型定义）
3. 基础中间件必须实现（CORS、请求日志、请求限流）
4. 统一的错误处理和响应格式必须标准化
5. API健康检查端点必须可用（/api/health）
6. 请求验证框架必须集成（使用Zod）
7. API文档生成系统必须配置（OpenAPI规范）

## Tasks / Subtasks
- [ ] Task 1: 创建API目录结构和路由约定 (AC: 1)
  - [ ] 创建app/api/目录结构
  - [ ] 设置RESTful路由命名规范
  - [ ] 创建路由处理器模板文件
  - [ ] 配置route segments和动态路由
- [ ] Task 2: 配置环境变量管理 (AC: 2)
  - [ ] 创建.env.local.example模板文件
  - [ ] 定义环境变量TypeScript类型
  - [ ] 实现环境变量验证工具
  - [ ] 设置不同环境的配置策略
- [ ] Task 3: 实现基础中间件系统 (AC: 3)
  - [ ] 创建CORS中间件配置
  - [ ] 实现请求日志中间件
  - [ ] 添加请求限流（rate limiting）中间件
  - [ ] 创建中间件组合工具函数
- [ ] Task 4: 标准化错误处理和响应格式 (AC: 4)
  - [ ] 定义统一的API响应类型
  - [ ] 创建错误处理工具类
  - [ ] 实现全局错误捕获机制
  - [ ] 定义错误代码和消息映射
- [ ] Task 5: 实现健康检查和监控端点 (AC: 5)
  - [ ] 创建/api/health端点
  - [ ] 添加系统状态检查逻辑
  - [ ] 实现版本信息端点
  - [ ] 添加基础性能指标
- [ ] Task 6: 集成请求验证框架 (AC: 6)
  - [ ] 安装和配置Zod
  - [ ] 创建通用验证中间件
  - [ ] 定义基础验证schemas
  - [ ] 实现验证错误处理
- [ ] Task 7: 配置API文档系统 (AC: 7)
  - [ ] 设置OpenAPI规范配置
  - [ ] 创建API文档生成脚本
  - [ ] 实现Swagger UI端点（开发环境）
  - [ ] 添加API版本管理
- [ ] Task 8: 编写测试和文档 (AC: 所有)
  - [ ] 为中间件编写单元测试
  - [ ] 为错误处理编写测试
  - [ ] 创建API开发指南文档
  - [ ] 编写集成测试for健康检查端点

## Dev Notes

### 技术栈信息
[Source: architecture/tech-stack.md]
- **语言**: TypeScript 5.x
- **后端框架**: Next.js API Routes 14.x
- **数据库**: PostgreSQL 15.x (后续story配置)
- **ORM**: Prisma 5.x (后续story配置)
- **认证**: NextAuth.js v5 beta (后续story配置)
- **验证**: Zod (本story集成)
- **部署**: Vercel & Supabase

### 项目结构
[Source: architecture/source-tree.md]
- 采用清晰的单体仓库文件结构
- 分离`app/` (UI/路由)和`lib/` (核心逻辑)
- 通过`types/`共享类型定义

### 文件位置规划
基于Next.js 14 App Router，新文件应创建在：
- `app/api/` - API路由目录
  - `app/api/health/route.ts` - 健康检查端点
  - `app/api/v1/` - 版本化API目录（预留）
- `lib/api/` - API相关工具和服务
  - `lib/api/middleware/` - 中间件实现
  - `lib/api/middleware/cors.ts` - CORS中间件
  - `lib/api/middleware/logging.ts` - 日志中间件
  - `lib/api/middleware/rate-limit.ts` - 限流中间件
  - `lib/api/response.ts` - 响应格式化工具
  - `lib/api/errors.ts` - 错误处理工具
  - `lib/api/validation.ts` - 验证工具
- `lib/config/` - 配置管理
  - `lib/config/env.ts` - 环境变量管理
  - `lib/config/constants.ts` - 常量定义
- `types/api.d.ts` - API相关类型定义
- `types/env.d.ts` - 环境变量类型定义

### 后端架构原则
[Source: architecture/10-后端架构.md]
- 完全拥抱Serverless理念
- 利用Next.js API Routes构建
- 通过Prisma单例模式访问数据库（后续实现）
- NextAuth.js处理认证（后续实现）

### API规范
[Source: architecture/4-api规范.md]
- 采用OpenAPI 3.0定义RESTful API
- 核心端点包括:
  - `/api/projects` (GET, POST) - 后续story实现
  - `/api/analyze` (POST) - 后续story实现
  - `/api/analyze/{id}` (GET) - 后续story实现
- 所有需认证的端点都将通过NextAuth.js的会话保护

### 环境变量规划
需要配置的环境变量：
```env
# Application
NODE_ENV=development
NEXT_PUBLIC_APP_URL=http://localhost:3000
NEXT_PUBLIC_API_VERSION=v1

# Database (后续story使用)
DATABASE_URL=

# Authentication (后续story使用)
NEXTAUTH_URL=
NEXTAUTH_SECRET=

# AI Service (已在Story 1.1配置)
DEEPSEEK_API_KEY=
DEEPSEEK_API_URL=

# Monitoring
LOG_LEVEL=info
ENABLE_API_DOCS=true
```

### 中间件实现策略
使用Next.js 14的新中间件模式：
```typescript
// 在route.ts中使用
export async function GET(request: Request) {
  return withMiddleware(request, async () => {
    // 业务逻辑
  });
}
```

### 错误处理策略
[Source: architecture/17-错误处理策略.md]
- 实施贯穿全栈的统一错误处理策略
- 向用户显示友好提示
- 记录可追踪的错误信息

### 响应格式标准
```typescript
interface ApiResponse<T = any> {
  success: boolean;
  data?: T;
  error?: {
    code: string;
    message: string;
    details?: any;
  };
  meta?: {
    timestamp: string;
    version: string;
    requestId?: string;
  };
}
```

### 安全考虑
[Source: architecture/14-安全与性能.md]
- 依赖NextAuth.js处理认证安全（后续实现）
- 使用Zod进行输入验证
- 通过环境变量管理密钥
- CORS配置限制允许的来源
- 实施请求限流防止滥用

### 性能优化
- 利用Next.js进行前端性能优化
- 后端采用异步处理
- 使用适当的缓存策略
- 监控API响应时间

### 从前期Stories学到的经验
- Story 1.1已配置DeepSeek API集成
- 项目已有基础的类型定义体系
- 测试框架（Jest）已配置

## Testing
[Source: architecture/15-测试策略.md]
- 采用精简的测试金字塔
- 重点投入在核心逻辑的单元测试
- 测试文件位置：`__tests__/api/`目录
- 关键测试场景：
  - 中间件功能验证
  - 错误处理机制
  - 环境变量验证
  - API响应格式一致性
  - 健康检查端点可用性

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-07 | v1.0 | Initial story creation | Bob (Scrum Master) |

## Dev Agent Record

### Agent Model Used
[To be filled by Dev Agent]

### Debug Log References
[To be filled by Dev Agent]

### Completion Notes List
[To be filled by Dev Agent]

### File List
[To be filled by Dev Agent]

## QA Results
[To be filled by QA Agent]