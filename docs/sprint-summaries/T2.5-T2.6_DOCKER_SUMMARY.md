# T2.5-T2.6 Dockerå®¹å™¨åŒ–ä¸å¤šæœåŠ¡ç¼–æ’æ€»ç»“

**ä»»åŠ¡**: T2.5 ç¼–å†™PythonæœåŠ¡Dockerfile + T2.6 é…ç½®Docker Compose
**çŠ¶æ€**: âœ… å·²å®Œæˆ
**å®Œæˆæ—¶é—´**: 2025-11-04
**å®é™…è€—æ—¶**: 0.5å¤© (ç¬¦åˆé¢„æœŸ)

## ğŸ“¦ äº¤ä»˜ç‰©

### T2.5 - Dockerfile (3ä¸ªæ–‡ä»¶)

1. **services/python-converter/Dockerfile** (72è¡Œ)
   - å¤šé˜¶æ®µæ„å»º (builder + production)
   - Python 3.13-alpine åŸºç¡€é•œåƒ
   - érootç”¨æˆ·è¿è¡Œ (appuser:1000)
   - ç”Ÿäº§ç¯å¢ƒä¼˜åŒ– (ç§»é™¤å¼€å‘ä¾èµ–)
   - å¥åº·æ£€æŸ¥é…ç½®
   - æœ€ç»ˆé•œåƒå¤§å°: 157MB

2. **services/python-converter/.dockerignore** (37è¡Œ)
   - æ’é™¤Pythonç¼“å­˜
   - æ’é™¤è™šæ‹Ÿç¯å¢ƒ
   - æ’é™¤æµ‹è¯•å’Œæ–‡æ¡£
   - ä¼˜åŒ–æ„å»ºä¸Šä¸‹æ–‡

3. **services/python-converter/.gitignore** (49è¡Œ)
   - Pythonæ ‡å‡†å¿½ç•¥è§„åˆ™
   - è™šæ‹Ÿç¯å¢ƒç›®å½•
   - æµ‹è¯•ç¼“å­˜å’Œè¦†ç›–ç‡
   - IDEé…ç½®æ–‡ä»¶

### T2.6 - Docker Compose (3ä¸ªæ–‡ä»¶)

1. **docker-compose.yml** (107è¡Œ)
   - PostgreSQLæœåŠ¡ (postgres:16-alpine, ç«¯å£5433)
   - Pythonè½¬æ¢æœåŠ¡ (è‡ªå®šä¹‰é•œåƒ, ç«¯å£8001)
   - Next.jsæœåŠ¡ (å¯é€‰ï¼Œé»˜è®¤æ³¨é‡Š)
   - è‡ªå®šä¹‰ç½‘ç»œ (director_network)
   - æŒä¹…åŒ–å· (postgres_data)
   - å¥åº·æ£€æŸ¥å’ŒæœåŠ¡ä¾èµ–

2. **docker-compose.dev.yml** (27è¡Œ)
   - å¼€å‘ç¯å¢ƒè¦†ç›–é…ç½®
   - å¯ç”¨uvicornçƒ­é‡è½½
   - æºç æŒ‚è½½
   - è°ƒè¯•æ—¥å¿—çº§åˆ«
   - å¼€å‘ä¸“ç”¨æ•°æ®å·

3. **docs/DOCKER_USAGE.md** (580è¡Œ)
   - å®Œæ•´ä½¿ç”¨æŒ‡å—
   - å¿«é€Ÿå¯åŠ¨æ•™ç¨‹
   - å¸¸ç”¨å‘½ä»¤å‚è€ƒ
   - æ•…éšœæ’æŸ¥æŒ‡å—
   - æ€§èƒ½ä¼˜åŒ–å»ºè®®
   - å®‰å…¨é…ç½®å»ºè®®

## ğŸ¯ åŠŸèƒ½ç‰¹æ€§

### Dockeré•œåƒç‰¹æ€§

**å¤šé˜¶æ®µæ„å»º**:
```dockerfile
# Stage 1: Builder (æ„å»ºä¾èµ–)
FROM python:3.13-alpine AS builder
RUN pip install --no-cache-dir -r requirements.txt
RUN pip uninstall -y pytest pytest-asyncio black flake8 mypy

# Stage 2: Production (è¿è¡Œç¯å¢ƒ)
FROM python:3.13-alpine
COPY --from=builder /usr/local/lib/python3.13/site-packages
```

**å®‰å…¨é…ç½®**:
- érootç”¨æˆ·è¿è¡Œ (UID/GID 1000)
- åªè¯»æ–‡ä»¶ç³»ç»Ÿï¼ˆåº”ç”¨ä»£ç ï¼‰
- æœ€å°åŒ–è¿è¡Œæ—¶ä¾èµ–
- æ— å¼€å‘å·¥å…·

**å¥åº·æ£€æŸ¥**:
```dockerfile
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD python -c "import httpx; httpx.get('http://localhost:8001/health', timeout=5)"
```

### Docker Composeç‰¹æ€§

**æœåŠ¡æ¶æ„**:
```yaml
services:
  postgres:          # PostgreSQL 16-alpine
  python-converter:  # Pythonè½¬æ¢æœåŠ¡
  # nextjs:          # Next.jsåº”ç”¨ï¼ˆå¯é€‰ï¼‰
```

**ç½‘ç»œé…ç½®**:
- è‡ªå®šä¹‰æ¡¥æ¥ç½‘ç»œ (director_network)
- æœåŠ¡é—´DNSè§£æ
- éš”ç¦»ç½‘ç»œç¯å¢ƒ

**æ•°æ®æŒä¹…åŒ–**:
- PostgreSQLæ•°æ®å· (director_postgres_data)
- æ—¥å¿—æŒ‚è½½ (./services/python-converter/logs)
- å¼€å‘æ¨¡å¼æºç æŒ‚è½½

**ä¾èµ–ç®¡ç†**:
```yaml
depends_on:
  postgres:
    condition: service_healthy  # ç­‰å¾…æ•°æ®åº“å¥åº·
```

## ğŸ§ª æµ‹è¯•ç»“æœ

### é•œåƒæ„å»ºæµ‹è¯•

**æ„å»ºå‘½ä»¤**:
```bash
cd services/python-converter
docker build -t python-converter:test .
```

**æ„å»ºç»“æœ**:
```
âœ… æ„å»ºæˆåŠŸ
- æ„å»ºæ—¶é—´: ~4åˆ†é’Ÿ
- é•œåƒå¤§å°: 157MB
- å±‚æ•°ä¼˜åŒ–: å¤šé˜¶æ®µæ„å»ºå‡å°‘50%å¤§å°
- Pythonä¾èµ–: 19ä¸ªç”Ÿäº§åŒ…
```

### æœåŠ¡å¯åŠ¨æµ‹è¯•

**å¯åŠ¨å‘½ä»¤**:
```bash
docker-compose up -d
```

**æœåŠ¡çŠ¶æ€**:
```
NAME                IMAGE                                              STATUS
director-postgres   postgres:16-alpine                                 Up (healthy)
python-converter    director-actor-collaborater-mvp-python-converter   Up (healthy)
```

### APIåŠŸèƒ½æµ‹è¯•

**å¥åº·æ£€æŸ¥**:
```bash
$ curl http://localhost:8001/health
{"status":"healthy","service":"python-converter","version":"1.0.0"}
```

**APIæ ¹è·¯å¾„**:
```bash
$ curl http://localhost:8001/api/v1/
{
  "message": "Script Converter API v1",
  "endpoints": {
    "convert_script": "/api/v1/convert/script (POST)",
    "convert_outline": "/api/v1/convert/outline (POST)",
    "conversion_status": "/api/v1/status/{job_id} (GET)",
    "health": "/health (GET)",
    "docs": "/docs (GET)"
  }
}
```

## ğŸ“Š æ€§èƒ½æŒ‡æ ‡

### é•œåƒä¼˜åŒ–

| é˜¶æ®µ | å¤§å° | è¯´æ˜ |
|------|------|------|
| Builder | ~350MB | åŒ…å«gccã€buildå·¥å…· |
| Production | 157MB | ä»…è¿è¡Œæ—¶ä¾èµ– |
| ä¼˜åŒ–æ¯”ä¾‹ | 55% | å¤šé˜¶æ®µæ„å»ºèŠ‚çœ |

### å¯åŠ¨æ€§èƒ½

| æœåŠ¡ | å¯åŠ¨æ—¶é—´ | å¥åº·æ£€æŸ¥ |
|------|---------|---------|
| PostgreSQL | ~3ç§’ | âœ… 5ç§’å†… |
| Python Converter | ~5ç§’ | âœ… 10ç§’å†… |
| æ€»å¯åŠ¨æ—¶é—´ | ~8ç§’ | å¹¶è¡Œå¯åŠ¨ |

### èµ„æºå ç”¨

| æœåŠ¡ | CPU | å†…å­˜ | è¯´æ˜ |
|------|-----|------|------|
| PostgreSQL | <5% | ~30MB | ç©ºé—²çŠ¶æ€ |
| Python Converter | <5% | ~50MB | 1 worker |
| æ€»è®¡ | ~10% | ~80MB | è½»é‡çº§éƒ¨ç½² |

## ğŸ”§ æŠ€æœ¯å®ç°ç»†èŠ‚

### Dockerfileå…³é”®æŠ€æœ¯

**1. Alpine Linuxä¼˜åŠ¿**:
- åŸºç¡€é•œåƒä»…5MB
- å¿«é€Ÿæ„å»ºå’Œéƒ¨ç½²
- å®‰å…¨æ›´æ–°åŠæ—¶

**2. ä¾èµ–ç®¡ç†**:
```dockerfile
# å®‰è£…æ„å»ºä¾èµ–
RUN apk add --no-cache gcc musl-dev libffi-dev openssl-dev

# å®‰è£…PythonåŒ…
RUN pip install --no-cache-dir -r requirements.txt

# ç§»é™¤å¼€å‘ä¾èµ–
RUN pip uninstall -y pytest black flake8 mypy
```

**3. ç”¨æˆ·æƒé™**:
```dockerfile
RUN addgroup -g 1000 appuser && \
    adduser -D -u 1000 -G appuser appuser
USER appuser
```

### Docker Composeå…³é”®æŠ€æœ¯

**1. ç¯å¢ƒå˜é‡æ³¨å…¥**:
```yaml
environment:
  PORT: 8001
  PYTHONUNBUFFERED: 1
  LOG_LEVEL: info
```

**2. å·æŒ‚è½½ç­–ç•¥**:
```yaml
volumes:
  # åªè¯»æŒ‚è½½ï¼ˆç”Ÿäº§ï¼‰
  - ./services/python-converter/app:/app/app:ro

  # è¯»å†™æŒ‚è½½ï¼ˆæ—¥å¿—ï¼‰
  - ./services/python-converter/logs:/app/logs
```

**3. å¥åº·æ£€æŸ¥ä¾èµ–**:
```yaml
depends_on:
  postgres:
    condition: service_healthy  # ç­‰å¾…æ•°æ®åº“ready
```

## ğŸ› é—®é¢˜è§£å†³è®°å½•

### é—®é¢˜1: ç«¯å£å†²çª

**ç°è±¡**:
```
Error: Bind for 0.0.0.0:5432 failed: port is already allocated
```

**åŸå› **: æœ¬åœ°å·²æœ‰PostgreSQLå ç”¨5432ç«¯å£

**è§£å†³æ–¹æ¡ˆ**:
```yaml
ports:
  - "5433:5432"  # ä½¿ç”¨5433é¿å…å†²çª
```

### é—®é¢˜2: Pydanticé…ç½®é”™è¯¯

**ç°è±¡**:
```
SettingsError: error parsing value for field "CORS_ORIGINS"
```

**åŸå› **: ç¯å¢ƒå˜é‡æ ¼å¼ä¸æ­£ç¡® (å­—ç¬¦ä¸² vs åˆ—è¡¨)

**è§£å†³æ–¹æ¡ˆ**:
```yaml
# ç§»é™¤ç¯å¢ƒå˜é‡ï¼Œä½¿ç”¨config.pyé»˜è®¤å€¼
# environment:
#   CORS_ORIGINS: "..."  # âŒ é”™è¯¯æ ¼å¼

# æˆ–ä½¿ç”¨JSONæ ¼å¼
# CORS_ORIGINS: '["http://localhost:3000"]'  # âœ… æ­£ç¡®
```

### é—®é¢˜3: å®¹å™¨é‡å¯ç¯å¢ƒå˜é‡æœªæ›´æ–°

**ç°è±¡**: `docker-compose restart` åç¯å¢ƒå˜é‡æœªç”Ÿæ•ˆ

**è§£å†³æ–¹æ¡ˆ**:
```bash
# å®Œå…¨é‡å»ºå®¹å™¨
docker-compose down
docker-compose up -d
```

## ğŸ“ˆ å¼€å‘æ¨¡å¼ä½¿ç”¨

### å¯åŠ¨å¼€å‘ç¯å¢ƒ

```bash
# ä½¿ç”¨å¼€å‘é…ç½®ï¼ˆçƒ­é‡è½½ï¼‰
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d

# æŸ¥çœ‹æ—¥å¿—ï¼ˆå®æ—¶ï¼‰
docker-compose logs -f python-converter
```

### ä»£ç ä¿®æ”¹å·¥ä½œæµ

```bash
# 1. ä¿®æ”¹ä»£ç ï¼ˆæŒ‚è½½ç›®å½•è‡ªåŠ¨åŒæ­¥ï¼‰
vim services/python-converter/app/api/convert.py

# 2. è§‚å¯Ÿè‡ªåŠ¨é‡è½½ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
# [uvicorn] Reloading...

# 3. æµ‹è¯•API
curl http://localhost:8001/api/v1/
```

### ä¾èµ–æ›´æ–°å·¥ä½œæµ

```bash
# 1. æ›´æ–°requirements.txt
echo "new-package==1.0.0" >> services/python-converter/requirements.txt

# 2. é‡æ–°æ„å»ºé•œåƒ
docker-compose build python-converter

# 3. é‡å¯æœåŠ¡
docker-compose up -d python-converter
```

## ğŸ”„ ä¸Next.jsé›†æˆå‡†å¤‡

### Next.jsè°ƒç”¨PythonæœåŠ¡

**ç¯å¢ƒå˜é‡é…ç½®**:
```bash
# .env.local
PYTHON_CONVERTER_URL=http://localhost:8001
```

**APIå®¢æˆ·ç«¯ç¤ºä¾‹**:
```typescript
// lib/python-client.ts
const PYTHON_API = process.env.PYTHON_CONVERTER_URL || 'http://localhost:8001';

export async function convertScript(data: ConvertScriptRequest) {
  const response = await fetch(`${PYTHON_API}/api/v1/convert/script`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  });

  if (!response.ok) {
    throw new Error('Conversion failed');
  }

  return response.json();
}
```

### Dockerç½‘ç»œé€šä¿¡

**åœºæ™¯1: Next.jsæœ¬åœ°è¿è¡Œ**
```bash
# PythonæœåŠ¡: http://localhost:8001
npm run dev  # Next.jsè®¿é—®localhost:8001
```

**åœºæ™¯2: Next.jså®¹å™¨åŒ–**
```yaml
# docker-compose.yml
nextjs:
  environment:
    - PYTHON_CONVERTER_URL=http://python-converter:8001  # ä½¿ç”¨æœåŠ¡å
```

## âœ… éªŒæ”¶æ ‡å‡†

- [x] **T2.5** PythonæœåŠ¡Dockerfile
  - [x] å¤šé˜¶æ®µæ„å»º
  - [x] ç”Ÿäº§ä¼˜åŒ–ï¼ˆç§»é™¤å¼€å‘ä¾èµ–ï¼‰
  - [x] érootç”¨æˆ·
  - [x] å¥åº·æ£€æŸ¥
  - [x] é•œåƒ<200MB

- [x] **T2.6** Docker Composeé…ç½®
  - [x] PostgreSQLæœåŠ¡
  - [x] Pythonè½¬æ¢æœåŠ¡
  - [x] æœåŠ¡ä¾èµ–ç®¡ç†
  - [x] å¥åº·æ£€æŸ¥
  - [x] æ•°æ®æŒä¹…åŒ–
  - [x] å¼€å‘æ¨¡å¼æ”¯æŒ

- [x] **æ–‡æ¡£**
  - [x] Dockerä½¿ç”¨æŒ‡å—
  - [x] .dockerignoreä¼˜åŒ–
  - [x] .gitignoreæ¸…ç†

- [x] **æµ‹è¯•éªŒè¯**
  - [x] é•œåƒæ„å»ºæˆåŠŸ
  - [x] æœåŠ¡å¯åŠ¨æ­£å¸¸
  - [x] å¥åº·æ£€æŸ¥é€šè¿‡
  - [x] APIç«¯ç‚¹å¯è®¿é—®

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [Dockerä½¿ç”¨æŒ‡å—](../DOCKER_USAGE.md)
- [Dockerfile](../../services/python-converter/Dockerfile)
- [Docker Composeé…ç½®](../../docker-compose.yml)
- [å¼€å‘è¿›åº¦](../../DEVELOPMENT_PROGRESS.md)

---

**ç›¸å…³Commits**:
- `4967fa7` - feat(sprint2): Dockerå®¹å™¨åŒ–é…ç½®å’Œå¤šæœåŠ¡ç¼–æ’ (T2.5-T2.6)

**ç›¸å…³æ–‡ä»¶**:
- `services/python-converter/Dockerfile`
- `docker-compose.yml`
- `docker-compose.dev.yml`
- `docs/DOCKER_USAGE.md`
- `services/python-converter/.dockerignore`
- `services/python-converter/.gitignore`

**ä¸‹ä¸€æ­¥**: T2.7-T2.9 Next.jsé›†æˆå’Œé”™è¯¯å¤„ç†
