# Deployment Guide

Complete guide for deploying ScriptAI to production environments.

## Deployment Overview

**Primary Platform**: Vercel (Serverless)
**Database**: Supabase PostgreSQL
**Requirements**: Vercel Pro Plan or higher (for 60s function timeouts)

## Quick Deployment Checklist

```bash
# 1. Set up Supabase database
# Copy connection strings from Supabase dashboard

# 2. Configure environment variables in Vercel
# DATABASE_URL, DIRECT_URL, DEEPSEEK_API_KEY

# 3. Build locally to verify
npx prisma generate
npm run build

# 4. Deploy to Vercel
vercel --prod

# 5. Run migrations on production database
npx prisma migrate deploy

# 6. Seed demo user
npx prisma db seed
```

## Prerequisites

### Vercel Account
- **Plan**: Pro Plan or higher (Hobby plan has 10s timeout limit)
- **Reason**: AI endpoints need 60s timeout for large scripts
- **Cost**: ~$20/month

### Supabase Account
- **Plan**: Free tier is sufficient for MVP
- **Database**: PostgreSQL 16
- **Features Needed**: Connection Pooling (pgbouncer)

### DeepSeek API Key
- Sign up at https://platform.deepseek.com/
- Create API key
- Verify sufficient credits/quota

## Environment Configuration

### Required Environment Variables

**Vercel Dashboard** → Project Settings → Environment Variables:

```bash
# Database (Supabase)
DATABASE_URL="postgresql://postgres.xxx:password@aws-0-us-east-1.pooler.supabase.com:6543/postgres?pgbouncer=true&connection_limit=1"
DIRECT_URL="postgresql://postgres.xxx:password@aws-0-us-east-1.pooler.supabase.com:5432/postgres"

# DeepSeek API
DEEPSEEK_API_KEY=sk-xxx...
DEEPSEEK_API_URL=https://api.deepseek.com

# Next.js (auto-generated by Vercel)
NEXTAUTH_URL=https://your-domain.vercel.app
NEXTAUTH_SECRET=xxx... # Min 32 characters
```

### Critical Configuration Notes

1. **DATABASE_URL**: Must use connection pooler (port 6543) with `pgbouncer=true`
   - **Reason**: Serverless functions need connection pooling to avoid exhausting database connections
   - **Connection Limit**: Set to 1 per function

2. **DIRECT_URL**: Uses direct connection (port 5432)
   - **Reason**: Required for migrations and schema operations
   - **Usage**: `npx prisma migrate deploy` only

3. **DO NOT** include `prisma db push` in build command
   - **Reason**: No database access during Vercel build phase
   - **Solution**: Run migrations after deployment

## Vercel Configuration

### vercel.json

**Location**: Root directory

```json
{
  "buildCommand": "npx prisma generate && npm run build",
  "functions": {
    "app/api/v1/analyze/route.ts": {
      "maxDuration": 60
    },
    "app/api/v1/analyze/process/route.ts": {
      "maxDuration": 60
    },
    "app/api/v1/iteration/propose/route.ts": {
      "maxDuration": 60
    },
    "app/api/v1/iteration/execute/route.ts": {
      "maxDuration": 60
    },
    "app/api/v1/synthesize/route.ts": {
      "maxDuration": 60
    }
  }
}
```

### Timeout Configuration

**Critical**: All AI endpoints need 60s timeout (Vercel Pro Plan minimum)

**Endpoints Requiring 60s**:
- `/api/v1/analyze/route.ts` - ACT1 analysis
- `/api/v1/analyze/process/route.ts` - Manual job processing
- `/api/v1/iteration/propose/route.ts` - ACT2-5 proposal generation
- `/api/v1/iteration/execute/route.ts` - ACT2-5 proposal execution
- `/api/v1/synthesize/route.ts` - V2 synthesis

**Performance Expectations**:
- Small scripts (<1000 lines): 10-20 seconds
- Medium scripts (1000-3000 lines): 30-60 seconds
- Large scripts (3000-10000 lines): 2-5 minutes (will timeout on Hobby plan)

## Database Setup

### Supabase Project Creation

1. Go to https://supabase.com/dashboard
2. Create new project
3. Note project credentials:
   - Database password
   - Connection string (pooler)
   - Direct connection string

### Connection Strings

**From Supabase Dashboard** → Project Settings → Database:

```
# Connection Pooler (pgbouncer) - Use for DATABASE_URL
postgresql://postgres.xxx:[PASSWORD]@aws-0-us-east-1.pooler.supabase.com:6543/postgres

# Direct Connection - Use for DIRECT_URL
postgresql://postgres.xxx:[PASSWORD]@aws-0-us-east-1.pooler.supabase.com:5432/postgres
```

**Add Required Parameters**:
```
DATABASE_URL="postgresql://postgres.xxx:[PASSWORD]@aws-0-us-east-1.pooler.supabase.com:6543/postgres?pgbouncer=true&connection_limit=1"
DIRECT_URL="postgresql://postgres.xxx:[PASSWORD]@aws-0-us-east-1.pooler.supabase.com:5432/postgres"
```

## Deployment Steps

### 1. Local Preparation

```bash
# Verify environment variables
cp .env.example .env
# Edit .env with production values

# Test build locally
npx prisma generate
npm run build

# Run type checking
npm run typecheck

# Run linting
npm run lint

# Run tests
npm test
```

### 2. Initial Deployment

```bash
# Install Vercel CLI (if not installed)
npm i -g vercel

# Login to Vercel
vercel login

# Deploy to production
vercel --prod
```

### 3. Post-Deployment Setup

```bash
# Set environment variables in Vercel dashboard
# Or via CLI:
vercel env add DATABASE_URL production
vercel env add DIRECT_URL production
vercel env add DEEPSEEK_API_KEY production

# Run migrations on production database
npx prisma migrate deploy

# Seed demo user
npx prisma db seed
```

### 4. Verify Deployment

```bash
# Test health endpoint
curl https://your-domain.vercel.app/api/health

# Test database connection
curl https://your-domain.vercel.app/api/debug/db

# Test environment variables (development only)
# curl https://your-domain.vercel.app/api/debug/env
```

## Monitoring & Logging

### Vercel Dashboard

**Deployments** → Select deployment → **Logs**:
- Real-time function logs
- Error tracking
- Performance metrics

### Key Metrics to Monitor

1. **Function Duration**:
   - ACT1 analysis: Should be < 60s for most scripts
   - ACT2-5 proposals: Should be < 60s
   - Synthesis: May exceed 60s for large scripts (3000+ lines)

2. **Database Connections**:
   - Should never exceed pool limit
   - Monitor via Supabase dashboard

3. **API Errors**:
   - 504 Gateway Timeout → Check function timeouts
   - 500 Internal Server Error → Check server logs
   - Database connection errors → Check connection pooling

### Error Handling Logs

All API routes log errors comprehensively:
```typescript
console.error('[Operation] Error:', error);
console.error('[Operation] Error details:', {
  name: error.name,
  message: error.message,
  stack: error.stack
});
```

Check Vercel logs for these error messages.

## Common Deployment Issues

### Issue 1: 504 Gateway Timeout

**Symptoms**:
- Analysis fails after 10 seconds (Hobby plan)
- Large scripts never complete

**Solution**:
1. Upgrade to Vercel Pro Plan
2. Verify `vercel.json` has `maxDuration: 60` for AI endpoints
3. Check DeepSeek API timeout (120s in `lib/api/deepseek/client.ts`)

**See**: `docs/fixes/VERCEL_504_TIMEOUT_FIX.md`

### Issue 2: Database Connection Pool Exhausted

**Symptoms**:
- "Too many connections" errors
- Random database failures

**Solution**:
1. Verify `DATABASE_URL` has `pgbouncer=true&connection_limit=1`
2. Check Supabase connection pool settings
3. Consider upgrading Supabase plan for more connections

### Issue 3: Prisma Client Not Generated

**Symptoms**:
- Build fails with "Cannot find module '@prisma/client'"
- Runtime errors about missing Prisma client

**Solution**:
1. Add `npx prisma generate` to build command in `vercel.json`
2. Verify build logs show "Prisma Client generated"

### Issue 4: Jobs Stuck in QUEUED State

**Symptoms**:
- Analysis never starts
- Jobs remain in QUEUED for minutes

**Solution**:
1. Verify Serverless mode detection in `lib/api/workflow-queue.ts`
2. Check frontend calls `v1ApiService.triggerProcessing()` during polling
3. Ensure `/api/v1/analyze/process` endpoint is accessible

**See**: "Serverless Compatibility Architecture" in CLAUDE.md

### Issue 5: HTML Error Pages Instead of JSON

**Symptoms**:
- Frontend receives HTML instead of JSON errors
- "Unexpected token <" JSON parse errors

**Solution**:
1. Verify ALL API routes return JSON (never throw)
2. Use `createErrorResponse()` for all errors
3. Check content-type header before parsing in frontend

**See**: `docs/fixes/ACT1_REPAIR_API_DEBUGGING.md`

### Issue 6: Missing Environment Variables

**Symptoms**:
- 500 errors on API calls
- "DEEPSEEK_API_KEY is not defined" errors

**Solution**:
1. Verify all env vars in Vercel dashboard
2. Check env vars are set for "Production" environment
3. Redeploy after adding new env vars

## Database Migration Strategy

### Initial Migration

```bash
# After first deployment
npx prisma migrate deploy
```

### Schema Changes

```bash
# 1. Create migration locally
npx prisma migrate dev --name [migration-name]

# 2. Test migration locally
npx prisma migrate reset
npx prisma db seed

# 3. Commit migration files
git add prisma/migrations
git commit -m "feat: add migration [name]"

# 4. Deploy to Vercel
git push origin main

# 5. Run migration on production
npx prisma migrate deploy
```

### Rollback Strategy

```bash
# 1. Revert migration files
git revert [commit-hash]

# 2. Deploy rollback
git push origin main

# 3. Manually fix production database if needed
# Use Supabase SQL Editor or Prisma Studio
```

## Performance Optimization

### 1. Database Query Optimization

- Use indexes for frequently queried fields
- Limit result sets with `take` parameter
- Select specific fields instead of full models
- Use connection pooling (already configured)

### 2. API Response Optimization

- Compress large responses (Next.js automatic)
- Cache static content (Vercel automatic)
- Minimize JSON payload size

### 3. Frontend Optimization

- Code splitting (Next.js automatic)
- Image optimization with `next/image`
- Lazy loading for heavy components

### 4. Background Job Optimization

- Parallel processing where possible
- Chunking for large scripts
- Progress tracking for user feedback

## Security Considerations

### 1. API Rate Limiting

**Production**: 10 requests/minute per user

Configured in `lib/api/middleware/rate-limit.ts`

### 2. CORS Configuration

**Allowed Origins**: Same domain only

Configured in `lib/api/middleware/cors.ts`

### 3. Security Headers

- X-Frame-Options: DENY
- X-Content-Type-Options: nosniff
- X-XSS-Protection: 1; mode=block
- Referrer-Policy: strict-origin-when-cross-origin

Configured in `lib/api/middleware/security-headers.ts`

### 4. Input Validation

All API endpoints use Zod schemas for validation.

### 5. SQL Injection Prevention

Prisma ORM provides parameterized queries (safe by default).

### 6. XSS Prevention

- React escapes output by default
- User input sanitized before storage
- CSP headers configured

## Backup Strategy

### Database Backups

**Supabase**: Automatic daily backups (free tier)

**Manual Backup**:
```bash
# Export database
pg_dump $DATABASE_URL > backup.sql

# Restore database
psql $DATABASE_URL < backup.sql
```

### Code Backups

- Git repository (primary)
- Vercel deployment history (secondary)
- Local backups (tertiary)

## Scaling Considerations

### Vertical Scaling

- Upgrade Vercel plan for more function memory
- Upgrade Supabase plan for more database resources

### Horizontal Scaling

- Add Redis for distributed rate limiting
- Add CDN for static assets (Vercel automatic)
- Add read replicas for database (Supabase feature)

### Cost Optimization

**Current Costs**:
- Vercel Pro: ~$20/month
- Supabase Free: $0/month (upgrade if needed)
- DeepSeek API: Pay-per-use

**Optimization Tips**:
- Monitor function invocation counts
- Optimize database queries to reduce CPU usage
- Cache frequently accessed data
- Implement request batching where possible

## Monitoring Setup

### Vercel Analytics

Enable in Vercel dashboard → Analytics tab

### Error Tracking

Consider integrating:
- Sentry (error tracking)
- LogRocket (session replay)
- Datadog (infrastructure monitoring)

### Custom Metrics

Log key metrics:
```typescript
console.log('[Metrics]', {
  operation: 'ACT1_ANALYSIS',
  duration: Date.now() - startTime,
  scriptLines: lineCount,
  errorsFound: errorCount
});
```

## Rollback Procedures

### Instant Rollback (Vercel)

1. Go to Vercel dashboard → Deployments
2. Find previous working deployment
3. Click "Promote to Production"
4. Confirm rollback

### Database Rollback

1. Stop all traffic (maintenance mode)
2. Restore database from backup
3. Revert code to matching version
4. Resume traffic

## Post-Deployment Checklist

- [ ] Verify health endpoint responds 200 OK
- [ ] Test script upload and analysis
- [ ] Test complete ACT1-5 workflow
- [ ] Test synthesis and export
- [ ] Monitor error rates in first 24 hours
- [ ] Check database connection pool usage
- [ ] Verify function durations within limits
- [ ] Test from multiple geographic locations
- [ ] Monitor DeepSeek API quota usage
- [ ] Set up monitoring alerts

## Support & Resources

### Documentation
- Vercel Docs: https://vercel.com/docs
- Supabase Docs: https://supabase.com/docs
- Prisma Docs: https://www.prisma.io/docs
- Next.js Docs: https://nextjs.org/docs

### Project Documentation
- Main guide: `docs/VERCEL_DEPLOYMENT_CHECKLIST.md`
- Timeout fix: `docs/fixes/VERCEL_504_TIMEOUT_FIX.md`
- API errors: `docs/fixes/ACT1_REPAIR_API_DEBUGGING.md`
- Deployment readiness: `docs/DEPLOYMENT_READINESS_REPORT.md`

### Troubleshooting
1. Check Vercel logs first
2. Review `docs/fixes/` for known issues
3. Check CLAUDE.md for critical implementation details
4. Use debug scripts in `scripts/` directory

## Related Documentation

- **API Reference**: See `ref/API_REFERENCE.md`
- **Database Schema**: See `ref/DATABASE_SCHEMA.md`
- **Testing Guide**: See `ref/TESTING_GUIDE.md`
- **Deployment Checklist**: See `docs/VERCEL_DEPLOYMENT_CHECKLIST.md`
- **Deployment Readiness**: See `docs/DEPLOYMENT_READINESS_REPORT.md`
